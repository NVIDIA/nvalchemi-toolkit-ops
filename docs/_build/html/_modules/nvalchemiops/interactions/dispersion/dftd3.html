
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nvalchemiops.interactions.dispersion.dftd3 &#8212; ALCHEMI Toolkit-Ops 0.1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/nvidia-sphinx-theme.css?v=b165022f" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../../../_static/documentation_options.js?v=38b66d78"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/nvalchemiops/interactions/dispersion/dftd3';</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/NVIDIA-Logo-V-ForScreen-ForLightBG.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../../../_static/NVIDIA-Logo-V-ForScreen-ForDarkBG.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">ALCHEMI Toolkit-Ops</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../userguide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../examples/index.html">
                        Examples Gallery
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../benchmarks/index.html">
                        Benchmarks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../modules/index.html">
                        API
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.github.com/NVIDIA/nvalchemi-toolkit-ops" title="Github" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Github</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../userguide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../examples/index.html">
                        Examples Gallery
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../benchmarks/index.html">
                        Benchmarks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../modules/index.html">
                        API
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.github.com/NVIDIA/nvalchemi-toolkit-ops" title="Github" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Github</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">nvalchemiops...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for nvalchemiops.interactions.dispersion.dftd3</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION &amp; AFFILIATES. All rights reserved.</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">DFT-D3(BJ) Dispersion Correction - Warp Kernel Implementation</span>

<span class="sd">This module implements the DFT-D3 dispersion correction with Becke-Johnson (BJ)</span>
<span class="sd">damping as Warp GPU/CPU kernels. The implementation provides efficient computation</span>
<span class="sd">of dispersion energies and forces using a multi-pass algorithm with support for</span>
<span class="sd">periodic boundary conditions, batched systems, and smooth cutoff functions.</span>

<span class="sd">For detailed theory, usage examples, and parameter setup, see the</span>
<span class="sd">:doc:`DFT-D3 User Guide &lt;/userguide/components/dispersion&gt;`.</span>

<span class="sd">Multi-Pass Kernel Architecture</span>
<span class="sd">-------------------------------</span>
<span class="sd">The implementation uses four kernel passes to efficiently handle the chain rule</span>
<span class="sd">dependency in force calculations:</span>

<span class="sd">1. **Pass 0 (_compute_cartesian_shifts)**: [PBC only] Convert unit cell shifts</span>
<span class="sd">   to Cartesian coordinates</span>

<span class="sd">2. **Pass 1 (_cn_kernel)**: Compute coordination numbers using geometric counting</span>
<span class="sd">   function</span>

<span class="sd">3. **Pass 2 (_direct_forces_and_dE_dCN_kernel)**: Compute C6 interpolation,</span>
<span class="sd">   dispersion energy, direct forces, and accumulate :math:`\\partial E/\\partial \\text{CN}`</span>

<span class="sd">4. **Pass 3 (_cn_forces_contrib_kernel)**: Add CN-dependent force contribution</span>
<span class="sd">   using precomputed :math:`\\partial E/\\partial \\text{CN}` values</span>

<span class="sd">PyTorch Interface</span>
<span class="sd">-----------------</span>
<span class="sd">Use :func:`dftd3` as the main entry point for PyTorch integration:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    from nvalchemiops.interactions.dispersion.dftd3 import (</span>
<span class="sd">        dftd3,</span>
<span class="sd">        D3Parameters,</span>
<span class="sd">    )</span>

<span class="sd">    # Using neighbor matrix format</span>
<span class="sd">    energy, forces, coord_num = dftd3(</span>
<span class="sd">        positions, numbers,</span>
<span class="sd">        neighbor_matrix=neighbor_matrix,</span>
<span class="sd">        a1=0.3981, a2=4.4211, s8=1.9889,</span>
<span class="sd">        d3_params=d3_params,  # D3Parameters instance or dict</span>
<span class="sd">        cell=cell,  # Optional for PBC</span>
<span class="sd">        neighbor_matrix_shifts=neighbor_matrix_shifts,  # Optional for PBC</span>
<span class="sd">    )</span>

<span class="sd">    # Using neighbor list format (sparse COO)</span>
<span class="sd">    energy, forces, coord_num = dftd3(</span>
<span class="sd">        positions, numbers,</span>
<span class="sd">        neighbor_list=neighbor_list,  # shape (2, num_pairs)</span>
<span class="sd">        a1=0.3981, a2=4.4211, s8=1.9889,</span>
<span class="sd">        d3_params=d3_params,</span>
<span class="sd">        cell=cell,  # Optional for PBC</span>
<span class="sd">        unit_shifts=unit_shifts,  # Optional for PBC, shape (num_pairs, 3)</span>
<span class="sd">    )</span>

<span class="sd">Data Structure Requirements</span>
<span class="sd">---------------------------</span>
<span class="sd">**Neighbor Formats**</span>

<span class="sd">The implementation supports two neighbor representation formats:</span>

<span class="sd">1. **Neighbor Matrix Format** (dense): `[num_atoms, max_neighbors]` where</span>
<span class="sd">   `neighbor_matrix[i, k]` is the k-th neighbor of atom i. Padding entries use</span>
<span class="sd">   values &gt;= `fill_value` (typically `num_atoms`).</span>

<span class="sd">2. **Neighbor List Format** (sparse COO): `[2, num_pairs]` where row 0 contains</span>
<span class="sd">   source atom indices and row 1 contains target atom indices. No padding needed.</span>

<span class="sd">Both formats can be generated by :func:`nvalchemiops.neighborlist.neighbor_list` using</span>
<span class="sd">the `return_neighbor_list` parameter.</span>

<span class="sd">**Parameter Arrays**</span>

<span class="sd">- `covalent_radii`: `[max_Z+1]` float32</span>
<span class="sd">- `r4r2`: `[max_Z+1]` float32</span>
<span class="sd">- `c6_reference`: `[max_Z+1, max_Z+1, 5, 5]` float32</span>
<span class="sd">- `coord_num_ref`: `[max_Z+1, max_Z+1, 5, 5]` float32</span>

<span class="sd">Index 0 reserved for padding; valid atomic numbers 1 to max_Z.</span>

<span class="sd">**Periodic Boundary Conditions**</span>

<span class="sd">- `cell`: `[num_systems, 3, 3]` lattice vectors (row format)</span>
<span class="sd">- For neighbor matrix: `neighbor_matrix_shifts`: `[num_atoms, max_neighbors, 3]` int32 unit cell shifts</span>
<span class="sd">- For neighbor list: `unit_shifts`: `[num_pairs, 3]` int32 unit cell shifts</span>

<span class="sd">Units</span>
<span class="sd">-----</span>
<span class="sd">Kernels are **unit-agnostic** but require consistency. Standard Grimme group</span>
<span class="sd">parameters use **atomic units (Bohr, Hartree)**, which is recommended:</span>

<span class="sd">- Positions, covalent radii, `a2`, cutoffs: Bohr</span>
<span class="sd">- Energy output: Hartree</span>
<span class="sd">- Forces output: Hartree/Bohr</span>
<span class="sd">- Parameter `k1`: 1/Bohr</span>

<span class="sd">Technical Notes</span>
<span class="sd">---------------</span>
<span class="sd">- Supports float32 and float64 positions and cell. Outputs are always float32</span>
<span class="sd">- **Two-body only**: Axilrod-Teller-Muto (C9) three-body terms not included</span>

<span class="sd">See Also</span>
<span class="sd">--------</span>
<span class="sd">:class:`D3Parameters` : Dataclass for parameter validation and management</span>
<span class="sd">:func:`dftd3` : Main PyTorch interface function</span>
<span class="sd">:doc:`/userguide/components/dispersion` : Complete user guide with theory and examples</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">wp</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;D3Parameters&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dftd3&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># ==============================================================================</span>
<span class="c1"># Data Structures</span>
<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="D3Parameters">
<a class="viewcode-back" href="../../../../modules/dispersion.html#nvalchemiops.interactions.dispersion.D3Parameters">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">D3Parameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DFT-D3 reference parameters for dispersion correction calculations.</span>

<span class="sd">    This dataclass encapsulates all element-specific parameters required for</span>
<span class="sd">    DFT-D3 dispersion corrections. The main purpose for this structure is to</span>
<span class="sd">    provide validation, ensuring the correct shapes, dtypes, and keys are</span>
<span class="sd">    present and complete. These parameters are used by :func:`dftd3`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rcov : torch.Tensor</span>
<span class="sd">        Covalent radii [max_Z+1] as float32 or float64. Units should be consistent</span>
<span class="sd">        with position coordinates. Index 0 is reserved for</span>
<span class="sd">        padding; valid atomic numbers are 1 to max_Z.</span>
<span class="sd">    r4r2 : torch.Tensor</span>
<span class="sd">        &lt;r⁴&gt;/&lt;r²&gt; expectation values [max_Z+1] as float32 or float64.</span>
<span class="sd">        Dimensionless ratio used for computing C8 coefficients from C6 values.</span>
<span class="sd">    c6ab : torch.Tensor</span>
<span class="sd">        C6 reference coefficients [max_Z+1, max_Z+1, interp_mesh, interp_mesh]</span>
<span class="sd">        as float32 or float64. Units are energy x distance^6. Indexed by atomic numbers and coordination number reference indices.</span>
<span class="sd">    cn_ref : torch.Tensor</span>
<span class="sd">        Coordination number reference grid [max_Z+1, max_Z+1, interp_mesh, interp_mesh]</span>
<span class="sd">        as float32 or float64. Dimensionless CN values for Gaussian interpolation.</span>
<span class="sd">    interp_mesh : int, optional</span>
<span class="sd">        Size of the coordination number interpolation mesh. Default: 5</span>
<span class="sd">        (standard DFT-D3 uses a 5x5 grid)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If parameter shapes are inconsistent or invalid</span>
<span class="sd">    TypeError</span>
<span class="sd">        If parameters are not torch.Tensor or have invalid dtypes</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Parameters should use consistent units matching your coordinate system.</span>
<span class="sd">      Standard D3 parameters from the Grimme group use atomic units (Bohr for</span>
<span class="sd">      distances, Hartree x Bohr^6 for C6 coefficients).</span>
<span class="sd">    - Index 0 in all arrays is reserved for padding atoms (atomic number 0)</span>
<span class="sd">    - Valid atomic numbers range from 1 to max_z</span>
<span class="sd">    - The standard DFT-D3 implementation supports elements 1-94 (H to Pu)</span>
<span class="sd">    - Parameters can be float32 or float64; they will be converted to float32</span>
<span class="sd">      during computation for efficiency</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Create parameters from individual tensors:</span>

<span class="sd">    &gt;&gt;&gt; params = D3Parameters(</span>
<span class="sd">    ...     rcov=torch.rand(95),  # 94 elements + padding</span>
<span class="sd">    ...     r4r2=torch.rand(95),</span>
<span class="sd">    ...     c6ab=torch.rand(95, 95, 5, 5),</span>
<span class="sd">    ...     cn_ref=torch.rand(95, 95, 5, 5),</span>
<span class="sd">    ... )</span>

<span class="sd">    Create from a dictionary (e.g., loaded from file):</span>

<span class="sd">    &gt;&gt;&gt; state_dict = torch.load(&quot;dftd3_parameters.pt&quot;)</span>
<span class="sd">    &gt;&gt;&gt; params = D3Parameters(</span>
<span class="sd">    ...     rcov=state_dict[&quot;rcov&quot;],</span>
<span class="sd">    ...     r4r2=state_dict[&quot;r4r2&quot;],</span>
<span class="sd">    ...     c6ab=state_dict[&quot;c6ab&quot;],</span>
<span class="sd">    ...     cn_ref=state_dict[&quot;cn_ref&quot;],</span>
<span class="sd">    ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rcov</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="n">r4r2</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="n">c6ab</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="n">cn_ref</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="n">interp_mesh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate parameter shapes, dtypes, and physical constraints.&quot;&quot;&quot;</span>
        <span class="c1"># Type validation</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;rcov&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;r4r2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r4r2</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;c6ab&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c6ab</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;cn_ref&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn_ref</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must be a torch.Tensor, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must be float32 or float64, got </span><span class="si">{</span><span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Shape validation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;rcov must be 1D tensor [max_Z+1], got shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">max_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">max_z</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;rcov must have at least 2 elements (padding + 1 element), got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r4r2</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">max_z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;r4r2 must have shape [</span><span class="si">{</span><span class="n">max_z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] to match rcov, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r4r2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">expected_c6_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c6ab</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_c6_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;c6ab must have shape </span><span class="si">{</span><span class="n">expected_c6_shape</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">c6ab</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">expected_cn_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn_ref</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_cn_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;cn_ref must have shape </span><span class="si">{</span><span class="n">expected_cn_shape</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_ref</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Device consistency validation</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r4r2</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c6ab</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cn_ref</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">})</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;All parameters must be on the same device. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got devices: rcov=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">, r4r2=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r4r2</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;c6ab=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">c6ab</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">, cn_ref=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_ref</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_z</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maximum atomic number supported by these parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Device where parameters are stored.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">device</span>

<div class="viewcode-block" id="D3Parameters.to">
<a class="viewcode-back" href="../../../../modules/dispersion.html#nvalchemiops.interactions.dispersion.D3Parameters.to">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">D3Parameters</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move all parameters to the specified device and/or convert to specified dtype.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device : str or torch.device or None, optional</span>
<span class="sd">            Target device (e.g., &#39;cpu&#39;, &#39;cuda&#39;, &#39;cuda:0&#39;). If None, keeps current device.</span>
<span class="sd">        dtype : torch.dtype or None, optional</span>
<span class="sd">            Target dtype (e.g., torch.float32, torch.float64). If None, keeps current dtype.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        D3Parameters</span>
<span class="sd">            New instance with parameters on the target device and/or dtype</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Move to GPU:</span>

<span class="sd">        &gt;&gt;&gt; params_gpu = params.to(device=&#39;cuda&#39;)</span>

<span class="sd">        Convert to float32:</span>

<span class="sd">        &gt;&gt;&gt; params_f32 = params.to(dtype=torch.float32)</span>

<span class="sd">        Move to GPU and convert to float32:</span>

<span class="sd">        &gt;&gt;&gt; params_gpu_f32 = params.to(device=&#39;cuda&#39;, dtype=torch.float32)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">D3Parameters</span><span class="p">(</span>
            <span class="n">rcov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rcov</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">r4r2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r4r2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">c6ab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c6ab</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">cn_ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_ref</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">interp_mesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_mesh</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># ==============================================================================</span>
<span class="c1"># Helper Functions</span>
<span class="c1"># ==============================================================================</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">func</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_s5_switch</span><span class="p">(</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r_on</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r_off</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">inv_w</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    C² smooth switching function for cutoff smoothing.</span>

<span class="sd">    This function provides a smooth transition from 1 to 0 over the interval</span>
<span class="sd">    [r_on, r_off]. The switching polynomial S5(t) has continuous first and</span>
<span class="sd">    second derivatives at the boundaries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r : float32</span>
<span class="sd">        Distance between atoms</span>
<span class="sd">    r_on : float32</span>
<span class="sd">        Distance where switching begins</span>
<span class="sd">    r_off : float32</span>
<span class="sd">        Distance where switching completes</span>
<span class="sd">    inv_w : float32</span>
<span class="sd">        Precomputed 1/(r_off - r_on) for efficiency</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Sw : float32</span>
<span class="sd">        Switching function value Sw(r) ∈ [0, 1]</span>
<span class="sd">    dSw_dr : float32</span>
<span class="sd">        Derivative of switching function with respect to r</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The switching function is defined as:</span>

<span class="sd">    .. math::</span>

<span class="sd">        S_w(r) = \\begin{cases}</span>
<span class="sd">        1 &amp; \\text{if } r \\leq r_{\\text{on}} \\\\</span>
<span class="sd">        1 - S_5(t) &amp; \\text{if } r_{\\text{on}} &lt; r &lt; r_{\\text{off}} \\\\</span>
<span class="sd">        0 &amp; \\text{if } r \\geq r_{\\text{off}}</span>
<span class="sd">        \\end{cases}</span>

<span class="sd">    where :math:`t = (r - r_{\\text{on}})/(r_{\\text{off}} - r_{\\text{on}}) \\in (0,1)` and</span>

<span class="sd">    .. math::</span>

<span class="sd">        S_5(t) = 10t^3 - 15t^4 + 6t^5</span>

<span class="sd">    The derivative is:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\frac{dS_5}{dt} = 30t^2 - 60t^3 + 30t^4</span>

<span class="sd">        \\frac{dS_w}{dr} = -\\frac{dS_5}{dt} \\cdot \\frac{1}{r_{\\text{off}} - r_{\\text{on}}}</span>

<span class="sd">    This ensures :math:`C^2` continuity (continuous function, first, and second derivatives)</span>
<span class="sd">    at both :math:`r_{\\text{on}}` and :math:`r_{\\text{off}}` boundaries.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nm` : Uses this switching function</span>
<span class="sd">    for cutoff smoothing (neighbor matrix)</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nl` : Uses this switching function</span>
<span class="sd">    for cutoff smoothing (neighbor list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">r_off</span> <span class="o">&lt;=</span> <span class="n">r_on</span><span class="p">:</span>
        <span class="c1"># disabled or degenerate: no switching</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">r_on</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">r_off</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">r_on</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_w</span>  <span class="c1"># t in (0,1)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">*</span> <span class="n">t</span>
    <span class="n">t4</span> <span class="o">=</span> <span class="n">t3</span> <span class="o">*</span> <span class="n">t</span>
    <span class="n">t5</span> <span class="o">=</span> <span class="n">t4</span> <span class="o">*</span> <span class="n">t</span>
    <span class="n">switch</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">10.0</span> <span class="o">*</span> <span class="n">t3</span> <span class="o">-</span> <span class="mf">15.0</span> <span class="o">*</span> <span class="n">t4</span> <span class="o">+</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="n">t5</span><span class="p">)</span>
    <span class="n">dSdt</span> <span class="o">=</span> <span class="o">-</span><span class="mf">30.0</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">+</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="n">t3</span> <span class="o">-</span> <span class="mf">30.0</span> <span class="o">*</span> <span class="n">t4</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">dSw_dr</span> <span class="o">=</span> <span class="n">dSdt</span> <span class="o">*</span> <span class="n">inv_w</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="k">return</span> <span class="n">switch</span><span class="p">,</span> <span class="n">dSw_dr</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">func</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_c6ab_interpolate</span><span class="p">(</span>
    <span class="n">cn_i</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">cn_j</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">c6ab_mat</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">cnref_i_mat</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">cnref_j_mat</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">k3</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolate C6 coefficient and CN derivatives using Gaussian weighting.</span>

<span class="sd">    This function performs Gaussian interpolation over a 5x5 reference grid</span>
<span class="sd">    to compute the environment-dependent C6 coefficient for an atom pair,</span>
<span class="sd">    along with derivatives with respect to coordination numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cn_i : float32</span>
<span class="sd">        Coordination number of atom i</span>
<span class="sd">    cn_j : float32</span>
<span class="sd">        Coordination number of atom j</span>
<span class="sd">    c6ab_mat : wp.array2d(dtype=float32)</span>
<span class="sd">        C6 reference values [5, 5] for this element pair</span>
<span class="sd">    cnref_i_mat : wp.array2d(dtype=float32)</span>
<span class="sd">        CN reference grid [5, 5] for atom i</span>
<span class="sd">    cnref_j_mat : wp.array2d(dtype=float32)</span>
<span class="sd">        CN reference grid [5, 5] for atom j</span>
<span class="sd">    k3 : float32</span>
<span class="sd">        Gaussian width parameter (typically -4.0)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c6_ij : float32</span>
<span class="sd">        Interpolated C6 coefficient</span>
<span class="sd">    dC6_dCNi : float32</span>
<span class="sd">        Derivative :math:`\\partial C_6/\\partial \text{CN}_i`</span>
<span class="sd">    dC6_dCNj : float32</span>
<span class="sd">        Derivative :math:`\\partial C_6/\\partial \text{CN}_j`</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The Gaussian weights are:</span>

<span class="sd">    .. math::</span>

<span class="sd">        L_{pq} = \\exp\\left(-k_3 \\left[(\\text{CN}_i - \\text{CN}_{\\text{ref},i}[p,q])^2 +</span>
<span class="sd">        (\\text{CN}_j - \\text{CN}_{\\text{ref},j}[p,q])^2\\right]\\right)</span>

<span class="sd">    The interpolated C6 and derivatives are:</span>

<span class="sd">    .. math::</span>

<span class="sd">        C_6 = \\frac{\\sum_{pq} C_6^{\\text{ref}}[p,q] L_{pq}}{\\sum_{pq} L_{pq}}</span>

<span class="sd">        \\frac{\\partial C_6}{\\partial \\text{CN}_i} = \\frac{2k_3}{w} (z_{d_i} - C_6 w_{d_i})</span>

<span class="sd">    where accumulators :math:`w`, :math:`z`, :math:`w_{d_i}`, :math:`z_{d_i}` are</span>
<span class="sd">    computed in a single pass over the 5x5 grid.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nm` : Calls this function for C6</span>
<span class="sd">    coefficient interpolation (neighbor matrix)</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nl` : Calls this function for C6</span>
<span class="sd">    coefficient interpolation (neighbor list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># log-sum-exp trick to avoid numerical instability</span>
    <span class="n">max_exp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="o">-</span><span class="mf">1e20</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">c6_val</span> <span class="o">=</span> <span class="n">c6ab_mat</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c6_val</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># NOSONAR (S1244) &quot;gpu kernel&quot;</span>
                <span class="k">continue</span>
            <span class="n">cnref_i</span> <span class="o">=</span> <span class="n">cnref_i_mat</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span>
            <span class="n">cnref_j</span> <span class="o">=</span> <span class="n">cnref_j_mat</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
            <span class="n">di</span> <span class="o">=</span> <span class="n">cn_i</span> <span class="o">-</span> <span class="n">cnref_i</span>
            <span class="n">dj</span> <span class="o">=</span> <span class="n">cn_j</span> <span class="o">-</span> <span class="n">cnref_j</span>
            <span class="n">exp_arg</span> <span class="o">=</span> <span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="n">di</span> <span class="o">*</span> <span class="n">di</span> <span class="o">+</span> <span class="n">dj</span> <span class="o">*</span> <span class="n">dj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exp_arg</span> <span class="o">&gt;</span> <span class="n">max_exp</span><span class="p">:</span>
                <span class="n">max_exp</span> <span class="o">=</span> <span class="n">exp_arg</span>

    <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">w_di</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">w_dj</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">z_di</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">z_dj</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">c6_val</span> <span class="o">=</span> <span class="n">c6ab_mat</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c6_val</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># NOSONAR (S1244) &quot;gpu kernel&quot;</span>
                <span class="k">continue</span>
            <span class="n">cnref_i</span> <span class="o">=</span> <span class="n">cnref_i_mat</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span>
            <span class="n">cnref_j</span> <span class="o">=</span> <span class="n">cnref_j_mat</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>  <span class="c1"># Note transpose indexing</span>
            <span class="n">di</span> <span class="o">=</span> <span class="n">cn_i</span> <span class="o">-</span> <span class="n">cnref_i</span>
            <span class="n">dj</span> <span class="o">=</span> <span class="n">cn_j</span> <span class="o">-</span> <span class="n">cnref_j</span>
            <span class="c1"># Compute exponent argument and skip negligible contributions</span>
            <span class="n">exp_arg</span> <span class="o">=</span> <span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="n">di</span> <span class="o">*</span> <span class="n">di</span> <span class="o">+</span> <span class="n">dj</span> <span class="o">*</span> <span class="n">dj</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_exp</span>
            <span class="k">if</span> <span class="n">exp_arg</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">12.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exp_arg</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="n">L</span>
            <span class="n">z</span> <span class="o">+=</span> <span class="n">c6_val</span> <span class="o">*</span> <span class="n">L</span>
            <span class="n">w_di</span> <span class="o">+=</span> <span class="n">L</span> <span class="o">*</span> <span class="n">di</span>
            <span class="n">w_dj</span> <span class="o">+=</span> <span class="n">L</span> <span class="o">*</span> <span class="n">dj</span>
            <span class="n">z_di</span> <span class="o">+=</span> <span class="n">c6_val</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="n">di</span>
            <span class="n">z_dj</span> <span class="o">+=</span> <span class="n">c6_val</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="n">dj</span>

    <span class="n">eps_w</span> <span class="o">=</span> <span class="mf">1e-12</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">eps_w</span><span class="p">:</span>
        <span class="n">w_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">w</span>
        <span class="n">c6_ij</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">w_inv</span>
        <span class="n">s_i</span> <span class="o">=</span> <span class="n">z_di</span> <span class="o">-</span> <span class="n">c6_ij</span> <span class="o">*</span> <span class="n">w_di</span>
        <span class="n">s_j</span> <span class="o">=</span> <span class="n">z_dj</span> <span class="o">-</span> <span class="n">c6_ij</span> <span class="o">*</span> <span class="n">w_dj</span>
        <span class="n">k3_w_w_inv</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">k3</span><span class="p">)</span> <span class="o">*</span> <span class="n">w_inv</span>
        <span class="n">dC6_dCNi</span> <span class="o">=</span> <span class="n">k3_w_w_inv</span> <span class="o">*</span> <span class="n">s_i</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">dC6_dCNj</span> <span class="o">=</span> <span class="n">k3_w_w_inv</span> <span class="o">*</span> <span class="n">s_j</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="k">return</span> <span class="n">c6_ij</span><span class="p">,</span> <span class="n">dC6_dCNi</span><span class="p">,</span> <span class="n">dC6_dCNj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">func</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_compute_distance_vector_pbc</span><span class="p">(</span>
    <span class="n">pos_i</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">pos_j</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">cartesian_shift</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">compute_vectors</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute distance with optional PBC and vector outputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos_i, pos_j : vec3</span>
<span class="sd">        Atomic positions</span>
<span class="sd">    cartesian_shift : vec3</span>
<span class="sd">        PBC shift (ignored if periodic=False)</span>
<span class="sd">    periodic : bool</span>
<span class="sd">        Apply PBC shift</span>
<span class="sd">    compute_vectors : bool</span>
<span class="sd">        If True, compute r_hat; if False, r_hat returns zero vector</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r : float32</span>
<span class="sd">        Distance</span>
<span class="sd">    r_inv : float32</span>
<span class="sd">        Inverse distance (0 if r &lt; 1e-12)</span>
<span class="sd">    r_hat : vec3f</span>
<span class="sd">        Unit vector (zero vec if compute_vectors=False or r &lt; 1e-12)</span>
<span class="sd">    r_ij : vec3f</span>
<span class="sd">        Distance vector (always returned)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">periodic</span><span class="p">:</span>
        <span class="n">r_ij_native</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos_j</span> <span class="o">-</span> <span class="n">pos_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">cartesian_shift</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_ij_native</span> <span class="o">=</span> <span class="n">pos_j</span> <span class="o">-</span> <span class="n">pos_i</span>

    <span class="n">r_ij</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">(</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">r_ij_native</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">r_ij_native</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">r_ij_native</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">r_ij</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">r_ij</span>

    <span class="n">r_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">r</span>

    <span class="k">if</span> <span class="n">compute_vectors</span><span class="p">:</span>
        <span class="n">r_hat</span> <span class="o">=</span> <span class="n">r_ij</span> <span class="o">*</span> <span class="n">r_inv</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">,</span> <span class="n">r_ij</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">r_ij</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">func</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_cn_counting</span><span class="p">(</span>
    <span class="n">r_inv</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">rcov_i</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">rcov_j</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">k1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">compute_derivative</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute CN counting function with optional derivative.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_inv : float32</span>
<span class="sd">        Inverse distance</span>
<span class="sd">    rcov_i, rcov_j : float32</span>
<span class="sd">        Covalent radii</span>
<span class="sd">    k1 : float32</span>
<span class="sd">        Steepness parameter</span>
<span class="sd">    compute_derivative : bool</span>
<span class="sd">        If True, compute dCN_dr; if False, returns None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    f_cn : float32</span>
<span class="sd">        Counting function value</span>
<span class="sd">    dCN_dr : float32</span>
<span class="sd">        Derivative (zero if compute_derivative=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rcov_ij</span> <span class="o">=</span> <span class="n">rcov_i</span> <span class="o">+</span> <span class="n">rcov_j</span>
    <span class="n">rcov_r_inv</span> <span class="o">=</span> <span class="n">rcov_ij</span> <span class="o">*</span> <span class="n">r_inv</span>
    <span class="n">f_cn</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">wp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="n">rcov_r_inv</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">compute_derivative</span><span class="p">:</span>
        <span class="n">dCN_dr</span> <span class="o">=</span> <span class="o">-</span><span class="n">f_cn</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">f_cn</span><span class="p">)</span> <span class="o">*</span> <span class="n">k1</span> <span class="o">*</span> <span class="n">rcov_r_inv</span> <span class="o">*</span> <span class="n">r_inv</span>  <span class="c1"># NOSONAR (S125)</span>
        <span class="k">return</span> <span class="n">f_cn</span><span class="p">,</span> <span class="n">dCN_dr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f_cn</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">func</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_bj_damping</span><span class="p">(</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r4r2_i</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r4r2_j</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">a1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">a2</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s6</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s8</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Becke-Johnson damping.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    damp_sum, r4r2_ij, r6, r4, den6_inv, den8_inv : float32</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r4r2_ij</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">r4r2_i</span> <span class="o">*</span> <span class="n">r4r2_j</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">wp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r4r2_ij</span><span class="p">)</span> <span class="o">+</span> <span class="n">a2</span>

    <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span>
    <span class="n">r4</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">*</span> <span class="n">r2</span>
    <span class="n">r6</span> <span class="o">=</span> <span class="n">r4</span> <span class="o">*</span> <span class="n">r2</span>
    <span class="n">r8</span> <span class="o">=</span> <span class="n">r4</span> <span class="o">*</span> <span class="n">r4</span>

    <span class="n">r0_2</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">r0</span>
    <span class="n">r0_4</span> <span class="o">=</span> <span class="n">r0_2</span> <span class="o">*</span> <span class="n">r0_2</span>
    <span class="n">r0_6</span> <span class="o">=</span> <span class="n">r0_4</span> <span class="o">*</span> <span class="n">r0_2</span>
    <span class="n">r0_8</span> <span class="o">=</span> <span class="n">r0_4</span> <span class="o">*</span> <span class="n">r0_4</span>

    <span class="n">den6</span> <span class="o">=</span> <span class="n">r6</span> <span class="o">+</span> <span class="n">r0_6</span>
    <span class="n">den8</span> <span class="o">=</span> <span class="n">r8</span> <span class="o">+</span> <span class="n">r0_8</span>
    <span class="n">den6_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">den6</span>
    <span class="n">den8_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">den8</span>

    <span class="n">damp_6</span> <span class="o">=</span> <span class="n">s6</span> <span class="o">*</span> <span class="n">den6_inv</span>
    <span class="n">damp_8</span> <span class="o">=</span> <span class="n">s8</span> <span class="o">*</span> <span class="n">r4r2_ij</span> <span class="o">*</span> <span class="n">den8_inv</span>
    <span class="n">damp_sum</span> <span class="o">=</span> <span class="n">damp_6</span> <span class="o">+</span> <span class="n">damp_8</span>

    <span class="k">return</span> <span class="n">damp_sum</span><span class="p">,</span> <span class="n">r4r2_ij</span><span class="p">,</span> <span class="n">r6</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">den6_inv</span><span class="p">,</span> <span class="n">den8_inv</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">func</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_dispersion_energy_force</span><span class="p">(</span>
    <span class="n">c6_ij</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r_hat</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">,</span>
    <span class="n">damp_sum</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r4r2_ij</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r6</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">r4</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">den6_inv</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">den8_inv</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s6</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s8</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s5_smoothing_on</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s5_smoothing_off</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">inv_w</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute dispersion energy and direct force with S5 switching.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    e_ij_sw : float32</span>
<span class="sd">        Smoothed energy</span>
<span class="sd">    F_direct : vec3f</span>
<span class="sd">        Direct force vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e_ij</span> <span class="o">=</span> <span class="o">-</span><span class="n">c6_ij</span> <span class="o">*</span> <span class="n">damp_sum</span>

    <span class="n">r5</span> <span class="o">=</span> <span class="n">r4</span> <span class="o">*</span> <span class="n">r</span>
    <span class="n">r7</span> <span class="o">=</span> <span class="n">r6</span> <span class="o">*</span> <span class="n">r</span>
    <span class="n">dD6_dr</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">s6</span> <span class="o">*</span> <span class="n">r5</span> <span class="o">*</span> <span class="n">den6_inv</span> <span class="o">*</span> <span class="n">den6_inv</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">dD8_dr</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">s8</span> <span class="o">*</span> <span class="n">r4r2_ij</span> <span class="o">*</span> <span class="n">r7</span> <span class="o">*</span> <span class="n">den8_inv</span> <span class="o">*</span> <span class="n">den8_inv</span>  <span class="c1"># NOSONAR (S125)</span>
    <span class="n">dE_dr_direct</span> <span class="o">=</span> <span class="o">-</span><span class="n">c6_ij</span> <span class="o">*</span> <span class="p">(</span><span class="n">dD6_dr</span> <span class="o">+</span> <span class="n">dD8_dr</span><span class="p">)</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>

    <span class="n">sw</span><span class="p">,</span> <span class="n">dsw_dr</span> <span class="o">=</span> <span class="n">_s5_switch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s5_smoothing_on</span><span class="p">,</span> <span class="n">s5_smoothing_off</span><span class="p">,</span> <span class="n">inv_w</span><span class="p">)</span>
    <span class="n">e_ij_sw</span> <span class="o">=</span> <span class="n">e_ij</span> <span class="o">*</span> <span class="n">sw</span>
    <span class="n">dE_dr_direct_sw</span> <span class="o">=</span> <span class="n">sw</span> <span class="o">*</span> <span class="n">dE_dr_direct</span> <span class="o">+</span> <span class="n">e_ij</span> <span class="o">*</span> <span class="n">dsw_dr</span>  <span class="c1"># NOSONAR (S125)</span>

    <span class="n">F_direct</span> <span class="o">=</span> <span class="n">dE_dr_direct_sw</span> <span class="o">*</span> <span class="n">r_hat</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>

    <span class="k">return</span> <span class="n">e_ij_sw</span><span class="p">,</span> <span class="n">F_direct</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">func</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_unit_shift_to_cartesian</span><span class="p">(</span>
    <span class="n">unit_shift</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3i</span><span class="p">,</span>
    <span class="n">cell_mat</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert integer unit cell shift to Cartesian coordinates.&quot;&quot;&quot;</span>
    <span class="n">unit_shift_float</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span>
        <span class="n">cell_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">unit_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">cell_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">unit_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">cell_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">unit_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">unit_shift_float</span> <span class="o">*</span> <span class="n">cell_mat</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># Kernels</span>
<span class="c1"># ==============================================================================</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_compute_cartesian_shifts</span><span class="p">(</span>
    <span class="n">cell</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">unit_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3i</span><span class="p">),</span>
    <span class="n">neighbor_matrix</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert unit cell shifts to Cartesian coordinates for periodic boundaries.</span>

<span class="sd">    For each neighbor in the neighbor matrix, this kernel computes the Cartesian</span>
<span class="sd">    shift vector that should be applied to atom j&#39;s position to obtain its</span>
<span class="sd">    periodic image closest to atom i.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cell : wp.array3d(dtype=float32)</span>
<span class="sd">        Unit cell lattice vectors [num_systems, 3, 3]. Convention: cell[s, i, :]</span>
<span class="sd">        is the i-th lattice vector for system s (row vectors). Units should match</span>
<span class="sd">        position coordinates.</span>
<span class="sd">    unit_shifts : wp.array2d(dtype=vec3i)</span>
<span class="sd">        Integer unit cell shifts [num_atoms, max_neighbors] as vec3i</span>
<span class="sd">    neighbor_matrix : wp.array2d(dtype=int32)</span>
<span class="sd">        Neighbor indices [num_atoms, max_neighbors]. See module docstring</span>
<span class="sd">        for more details.</span>
<span class="sd">    batch_idx : wp.array(dtype=int32)</span>
<span class="sd">        System index [num_atoms] for each atom</span>
<span class="sd">    fill_value : int32</span>
<span class="sd">        Value indicating padding in neighbor_matrix (typically num_atoms)</span>
<span class="sd">    cartesian_shifts : wp.array2d(dtype=vec3f)</span>
<span class="sd">        Output: Cartesian shift vectors [num_atoms, max_neighbors] as vec3 in same</span>
<span class="sd">        units as cell vectors</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The Cartesian shift is computed as:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\mathbf{s} = n_a \\mathbf{a} + n_b \\mathbf{b} + n_c \\mathbf{c}</span>

<span class="sd">    where :math:`\\mathbf{a}, \\mathbf{b}, \\mathbf{c}` are lattice vectors</span>
<span class="sd">    and :math:`n_a, n_b, n_c` are integer shifts. The system ID is obtained</span>
<span class="sd">    from atom i&#39;s batch index.</span>

<span class="sd">    Launch with dim=(num_atoms, max_neighbors) (one thread per atom-neighbor pair).</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`_cn_kernel_nm` : Pass 1 - Uses computed Cartesian shifts for PBC (neighbor matrix)</span>
<span class="sd">    :func:`_cn_kernel_nl` : Pass 1 - Uses computed Cartesian shifts for PBC (neighbor list)</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nm` : Pass 2 - Uses computed</span>
<span class="sd">    Cartesian shifts for PBC (neighbor matrix)</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nl` : Pass 2 - Uses computed</span>
<span class="sd">    Cartesian shifts for PBC (neighbor list)</span>
<span class="sd">    :func:`_cn_forces_contrib_kernel_nm` : Pass 3 - Uses computed Cartesian shifts for PBC (neighbor matrix)</span>
<span class="sd">    :func:`_cn_forces_contrib_kernel_nl` : Pass 3 - Uses computed Cartesian shifts for PBC (neighbor list)</span>
<span class="sd">    :func:`dftd3` : High-level wrapper that orchestrates all passes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>
    <span class="n">max_neighbors</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">neighbor_idx</span> <span class="o">&gt;=</span> <span class="n">max_neighbors</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">atom_j</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">atom_j</span> <span class="o">&gt;=</span> <span class="n">fill_value</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">system_id</span> <span class="o">=</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>

    <span class="n">cell_mat</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="n">system_id</span><span class="p">]</span>
    <span class="n">unit_shift</span> <span class="o">=</span> <span class="n">unit_shifts</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">]</span>
    <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unit_shift_to_cartesian</span><span class="p">(</span>
        <span class="n">unit_shift</span><span class="p">,</span> <span class="n">cell_mat</span>
    <span class="p">)</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_cn_kernel_nm</span><span class="p">(</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">neighbor_matrix</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">covalent_radii</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">k1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">coord_num</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute coordination numbers using geometric counting function.</span>

<span class="sd">    This kernel computes the coordination number (CN) for each atom based on</span>
<span class="sd">    a smooth counting function that depends on interatomic distances and</span>
<span class="sd">    covalent radii. Supports periodic boundary conditions via Cartesian shifts.</span>

<span class="sd">    Algorithm</span>
<span class="sd">    ---------</span>
<span class="sd">    For each atom i, iterate over its neighbors (neighbor matrix format) and accumulate:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\text{CN}_i = \\sum_{j \\in \\text{neighbors}(i)} f(r_{ij})</span>

<span class="sd">        f(r) = \\frac{1}{1 + \\exp\\left[k_1\\left(\\frac{r_{\\text{cov}}}{r} - 1\\right)\\right]}</span>

<span class="sd">    where :math:`r_{\\text{cov}} = r_{\\text{cov}}[Z_i] + r_{\\text{cov}}[Z_j]`.</span>
<span class="sd">    The counting function smoothly transitions from 1 (bonded) to 0 (non-bonded).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : wp.array(dtype=vec3f)</span>
<span class="sd">        Atomic coordinates [num_atoms]</span>
<span class="sd">    numbers : wp.array(dtype=int32)</span>
<span class="sd">        Atomic numbers [num_atoms]</span>
<span class="sd">    neighbor_matrix : wp.array2d(dtype=int32)</span>
<span class="sd">        Neighbor indices [num_atoms, max_neighbors]. See module docstring</span>
<span class="sd">        for more details.</span>
<span class="sd">    cartesian_shifts : wp.array2d(dtype=vec3f)</span>
<span class="sd">        Cartesian shifts [num_atoms, max_neighbors] as vec3 for PBC (ignored if periodic=False), in same units as positions</span>
<span class="sd">    covalent_radii : wp.array(dtype=float32)</span>
<span class="sd">        Covalent radii [max_Z+1] indexed by atomic number, in same units as positions</span>
<span class="sd">    k1 : float32</span>
<span class="sd">        Steepness parameter for counting function (typically 16.0 1/Bohr)</span>
<span class="sd">    fill_value : int32</span>
<span class="sd">        Value indicating padding in neighbor_matrix (typically num_atoms)</span>
<span class="sd">    periodic : bool</span>
<span class="sd">        If True, apply PBC using cartesian_shifts; if False, non-periodic</span>
<span class="sd">    coord_num : wp.array(dtype=float32)</span>
<span class="sd">        Output: coordination numbers [num_atoms] (dimensionless)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Launch with dim=num_atoms (one thread per atom)</span>
<span class="sd">    - Each thread iterates over all neighbors and accumulates CN in a local register</span>
<span class="sd">    - Padding atoms indicated by numbers[i] == 0 are skipped</span>
<span class="sd">    - Neighbor entries with j &gt;= fill_value are padding and are skipped</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`_compute_cartesian_shifts` : Pass 0 - Computes Cartesian shifts for PBC</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nm` : Pass 2 - Uses coordination numbers</span>
<span class="sd">    computed here</span>
<span class="sd">    :func:`dftd3` : High-level wrapper that orchestrates all passes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">atom_i</span> <span class="o">&gt;=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># skip padding atoms</span>
    <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">max_neighbors</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">rcov_i</span> <span class="o">=</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]]</span>

    <span class="c1"># Accumulate coordination number in local register</span>
    <span class="n">cn_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">neighbor_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_neighbors</span><span class="p">):</span>
        <span class="n">atom_j</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">atom_j</span> <span class="o">&gt;=</span> <span class="n">fill_value</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># skip padding</span>
        <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Compute distance with optional PBC shift</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">,</span> <span class="n">r_ij</span> <span class="o">=</span> <span class="n">_compute_distance_vector_pbc</span><span class="p">(</span>
            <span class="n">pos_i</span><span class="p">,</span>
            <span class="n">positions</span><span class="p">[</span><span class="n">atom_j</span><span class="p">],</span>
            <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">],</span>
            <span class="n">periodic</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Compute coordination number contribution</span>
        <span class="n">f_cn</span><span class="p">,</span> <span class="n">dCN_dr</span> <span class="o">=</span> <span class="n">_cn_counting</span><span class="p">(</span>
            <span class="n">r_inv</span><span class="p">,</span> <span class="n">rcov_i</span><span class="p">,</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]],</span> <span class="n">k1</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">cn_acc</span> <span class="o">+=</span> <span class="n">f_cn</span>

    <span class="c1"># Write final coordination number once</span>
    <span class="n">coord_num</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cn_acc</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_direct_forces_and_dE_dCN_kernel_nm</span><span class="p">(</span>  <span class="c1"># NOSONAR (S1542) &quot;math formula&quot;</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">neighbor_matrix</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">coord_num</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">r4r2</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">c6_reference</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">coord_num_ref</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">k3</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">a1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">a2</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s6</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s8</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s5_smoothing_on</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s5_smoothing_off</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">inv_w</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">compute_virial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">dE_dCN</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">forces</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
    <span class="n">energy</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">virial</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pass 2: Compute direct forces, energy, and accumulate dE/dCN per atom.</span>

<span class="sd">    Computes dispersion energy and forces at constant CN, and accumulates</span>
<span class="sd">    dE/dCN contributions for each atom for use in Pass 3.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : wp.array(dtype=vec3f)</span>
<span class="sd">        Atomic coordinates [num_atoms]</span>
<span class="sd">    numbers : wp.array(dtype=int32)</span>
<span class="sd">        Atomic numbers [num_atoms]</span>
<span class="sd">    neighbor_matrix : wp.array2d(dtype=int32)</span>
<span class="sd">        Neighbor indices [num_atoms, max_neighbors]. See module docstring</span>
<span class="sd">        for more details.</span>
<span class="sd">    cartesian_shifts : wp.array2d(dtype=vec3f)</span>
<span class="sd">        Cartesian shifts [num_atoms, max_neighbors] as vec3 for PBC, in same units as positions</span>
<span class="sd">    coord_num : wp.array(dtype=float32)</span>
<span class="sd">        Coordination numbers [num_atoms] from Pass 1 (dimensionless)</span>
<span class="sd">    r4r2 : wp.array(dtype=float32)</span>
<span class="sd">        &lt;r⁴&gt;/&lt;r²&gt; expectation values [max_Z+1] (dimensionless)</span>
<span class="sd">    c6_reference : wp.array4d(dtype=float32)</span>
<span class="sd">        C6 reference [max_Z+1, max_Z+1, 5, 5] in energy x distance^6 units</span>
<span class="sd">    coord_num_ref : wp.array4d(dtype=float32)</span>
<span class="sd">        CN reference grid [max_Z+1, max_Z+1, 5, 5] (dimensionless)</span>
<span class="sd">    k3 : float32</span>
<span class="sd">        CN interpolation width (typically -4.0, dimensionless)</span>
<span class="sd">    a1, a2 : float32</span>
<span class="sd">        Becke-Johnson damping parameters (a1 dimensionless, a2 in distance units)</span>
<span class="sd">    s6, s8 : float32</span>
<span class="sd">        Scaling factors for C6 and C8 terms (dimensionless)</span>
<span class="sd">    s5_smoothing_on, s5_smoothing_off : float32</span>
<span class="sd">        S5 switching radii in same units as positions</span>
<span class="sd">    inv_w : float32</span>
<span class="sd">        Precomputed 1/(s5_off - s5_on) in inverse distance units</span>
<span class="sd">    fill_value : int32</span>
<span class="sd">        Value indicating padding in neighbor_matrix (typically num_atoms)</span>
<span class="sd">    periodic : bool</span>
<span class="sd">        If True, apply PBC using cartesian_shifts</span>
<span class="sd">    batch_idx : wp.array(dtype=int32)</span>
<span class="sd">        System index [num_atoms]</span>
<span class="sd">    dE_dCN : wp.array(dtype=float32)</span>
<span class="sd">        Output: accumulated dE/dCN [num_atoms] in energy units</span>
<span class="sd">    forces : wp.array(dtype=vec3f)</span>
<span class="sd">        Output: direct forces [num_atoms] in energy/distance units</span>
<span class="sd">    energy : wp.array(dtype=float32)</span>
<span class="sd">        Output: system energies [num_systems] in energy units</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Launch with dim=num_atoms (one thread per atom)</span>
<span class="sd">    - Each thread iterates over all neighbors and accumulates results in local registers</span>
<span class="sd">    - Direct forces are F = :math:`-(\\partial E/\\partial r)|_\text{CN}`, without chain rule term</span>
<span class="sd">    - dE_dCN[i] = :math:`\\sum_j \\partial E_{ij}/\\partial \text{CN}_i` accumulated over all pairs containing atom i</span>
<span class="sd">    - Neighbor entries with j &gt;= fill_value are padding and are skipped</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`_compute_cartesian_shifts` : Pass 0 - Computes Cartesian shifts for PBC</span>
<span class="sd">    :func:`_cn_kernel_nm` : Pass 1 - Computes coordination numbers used here</span>
<span class="sd">    :func:`_cn_forces_contrib_kernel_nm` : Pass 3 - Uses dE/dCN values accumulated here</span>
<span class="sd">    :func:`_c6ab_interpolate` : Called to interpolate C6 coefficients</span>
<span class="sd">    :func:`_s5_switch` : Called for cutoff smoothing</span>
<span class="sd">    :func:`dftd3` : High-level wrapper that orchestrates all passes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">atom_i</span> <span class="o">&gt;=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># skip padding atoms</span>
    <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">max_neighbors</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">cn_i</span> <span class="o">=</span> <span class="n">coord_num</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">z_i</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">r4r2_i</span> <span class="o">=</span> <span class="n">r4r2</span><span class="p">[</span><span class="n">z_i</span><span class="p">]</span>

    <span class="c1"># Accumulate in local registers (using float64 for better precision)</span>
    <span class="n">F_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">()</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>
    <span class="n">dE_dCN_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>
    <span class="n">energy_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Initialize virial accumulator</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">virial_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">neighbor_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_neighbors</span><span class="p">):</span>
        <span class="n">atom_j</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">atom_j</span> <span class="o">&gt;=</span> <span class="n">fill_value</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># skip padding atoms</span>
        <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Geometry</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">,</span> <span class="n">r_ij</span> <span class="o">=</span> <span class="n">_compute_distance_vector_pbc</span><span class="p">(</span>
            <span class="n">pos_i</span><span class="p">,</span>
            <span class="n">positions</span><span class="p">[</span><span class="n">atom_j</span><span class="p">],</span>
            <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">],</span>
            <span class="n">periodic</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">cn_j</span> <span class="o">=</span> <span class="n">coord_num</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span>
        <span class="n">z_j</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span>

        <span class="c1"># C6 interpolation</span>
        <span class="n">c6ab_mat</span> <span class="o">=</span> <span class="n">c6_reference</span><span class="p">[</span><span class="n">z_i</span><span class="p">,</span> <span class="n">z_j</span><span class="p">]</span>
        <span class="n">cnref_i_mat</span> <span class="o">=</span> <span class="n">coord_num_ref</span><span class="p">[</span><span class="n">z_i</span><span class="p">,</span> <span class="n">z_j</span><span class="p">]</span>
        <span class="n">cnref_j_mat</span> <span class="o">=</span> <span class="n">coord_num_ref</span><span class="p">[</span><span class="n">z_j</span><span class="p">,</span> <span class="n">z_i</span><span class="p">]</span>

        <span class="n">c6_ij</span><span class="p">,</span> <span class="n">dC6_dCNi</span><span class="p">,</span> <span class="n">dC6_dCNj</span> <span class="o">=</span> <span class="n">_c6ab_interpolate</span><span class="p">(</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
            <span class="n">cn_i</span><span class="p">,</span> <span class="n">cn_j</span><span class="p">,</span> <span class="n">c6ab_mat</span><span class="p">,</span> <span class="n">cnref_i_mat</span><span class="p">,</span> <span class="n">cnref_j_mat</span><span class="p">,</span> <span class="n">k3</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">c6_ij</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># BJ damping</span>
        <span class="n">damp_sum</span><span class="p">,</span> <span class="n">r4r2_ij</span><span class="p">,</span> <span class="n">r6</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">den6_inv</span><span class="p">,</span> <span class="n">den8_inv</span> <span class="o">=</span> <span class="n">_bj_damping</span><span class="p">(</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">r4r2_i</span><span class="p">,</span> <span class="n">r4r2</span><span class="p">[</span><span class="n">z_j</span><span class="p">],</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">s6</span><span class="p">,</span> <span class="n">s8</span>
        <span class="p">)</span>

        <span class="c1"># Energy and direct force</span>
        <span class="n">e_ij_sw</span><span class="p">,</span> <span class="n">F_direct</span> <span class="o">=</span> <span class="n">_dispersion_energy_force</span><span class="p">(</span>
            <span class="n">c6_ij</span><span class="p">,</span>
            <span class="n">r</span><span class="p">,</span>
            <span class="n">r_hat</span><span class="p">,</span>
            <span class="n">damp_sum</span><span class="p">,</span>
            <span class="n">r4r2_ij</span><span class="p">,</span>
            <span class="n">r6</span><span class="p">,</span>
            <span class="n">r4</span><span class="p">,</span>
            <span class="n">den6_inv</span><span class="p">,</span>
            <span class="n">den8_inv</span><span class="p">,</span>
            <span class="n">s6</span><span class="p">,</span>
            <span class="n">s8</span><span class="p">,</span>
            <span class="n">s5_smoothing_on</span><span class="p">,</span>
            <span class="n">s5_smoothing_off</span><span class="p">,</span>
            <span class="n">inv_w</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Accumulate in registers</span>
        <span class="n">F_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">(</span><span class="n">F_direct</span><span class="p">)</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>
        <span class="n">energy_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">e_ij_sw</span><span class="p">)</span>
        <span class="n">dE_dCN_acc</span> <span class="o">+=</span> <span class="o">-</span><span class="n">damp_sum</span> <span class="o">*</span> <span class="n">dC6_dCNi</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>

        <span class="c1"># Accumulate virial if requested</span>
        <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
            <span class="n">virial_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">(</span><span class="n">wp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">F_direct</span><span class="p">,</span> <span class="n">r_ij</span><span class="p">))</span>

    <span class="c1"># Write final results once (atomic only for shared batch array)</span>
    <span class="c1"># Convert from float64 accumulation to float32 output</span>
    <span class="n">forces</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">(</span><span class="n">F_acc</span><span class="p">)</span>
    <span class="n">dE_dCN</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dE_dCN_acc</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">atomic_add</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">energy_acc</span><span class="p">))</span>

    <span class="c1"># Add virial contribution with -0.5 scaling for correct sign and double counting</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">atomic_add</span><span class="p">(</span><span class="n">virial</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">(</span><span class="n">virial_acc</span><span class="p">))</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_cn_forces_contrib_kernel_nm</span><span class="p">(</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">neighbor_matrix</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">covalent_radii</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">dE_dCN</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">k1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">compute_virial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">forces</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
    <span class="n">virial</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pass 3: Add CN-dependent force contribution.</span>

<span class="sd">    Adds the CN-dependent term to forces computed in Pass 2. Computes</span>
<span class="sd">    distances and CN derivatives without repeating C6 interpolation and</span>
<span class="sd">    damping calculations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : wp.array(dtype=vec3f)</span>
<span class="sd">        Atomic coordinates [num_atoms] in consistent distance units</span>
<span class="sd">    numbers : wp.array(dtype=int32)</span>
<span class="sd">        Atomic numbers [num_atoms]</span>
<span class="sd">    neighbor_matrix : wp.array2d(dtype=int32)</span>
<span class="sd">        Neighbor indices [num_atoms, max_neighbors]. See module docstring</span>
<span class="sd">        for more details.</span>
<span class="sd">    cartesian_shifts : wp.array2d(dtype=vec3f)</span>
<span class="sd">        Cartesian shifts [num_atoms, max_neighbors] as vec3 for PBC, in same units as positions</span>
<span class="sd">    covalent_radii : wp.array(dtype=float32)</span>
<span class="sd">        Covalent radii [max_Z+1] in same units as positions</span>
<span class="sd">    dE_dCN : wp.array(dtype=float32)</span>
<span class="sd">        Precomputed dE/dCN [num_atoms] from Pass 2 in energy units</span>
<span class="sd">    k1 : float32</span>
<span class="sd">        CN counting steepness in inverse distance units (typically 16.0 1/Bohr)</span>
<span class="sd">    fill_value : int32</span>
<span class="sd">        Value indicating padding in neighbor_matrix (typically num_atoms)</span>
<span class="sd">    periodic : bool</span>
<span class="sd">        If True, apply PBC using cartesian_shifts</span>
<span class="sd">    forces : wp.array(dtype=vec3f)</span>
<span class="sd">        Input/Output: add chain term to direct forces [num_atoms] in energy/distance units</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Launch with dim=num_atoms (one thread per atom)</span>
<span class="sd">    - Each thread iterates over all neighbors and accumulates results in local registers</span>
<span class="sd">    - Skips C6 interpolation and damping calculations</span>
<span class="sd">    - Uses precomputed dE_dCN[i] = :math:`\\sum_k \\partial E_{ik}/\\partial \text{CN}_i` from all pairs</span>
<span class="sd">    - Neighbor entries with j &gt;= fill_value are padding and are skipped</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`_compute_cartesian_shifts` : Pass 0 - Computes Cartesian shifts for PBC</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nm` : Pass 2 - Computes dE/dCN values used here</span>
<span class="sd">    :func:`dftd3` : High-level wrapper that orchestrates all passes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">atom_i</span> <span class="o">&gt;=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># skip padding atoms</span>
    <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">max_neighbors</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dE_dCN_i</span> <span class="o">=</span> <span class="n">dE_dCN</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">rcov_i</span> <span class="o">=</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]]</span>

    <span class="c1"># Accumulate force in local register (using float64 for better precision)</span>
    <span class="n">F_chain_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">()</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>

    <span class="c1"># Initialize virial accumulator</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">virial_chain_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">neighbor_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_neighbors</span><span class="p">):</span>
        <span class="n">atom_j</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">atom_j</span> <span class="o">&gt;=</span> <span class="n">fill_value</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Distance</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">,</span> <span class="n">r_ij</span> <span class="o">=</span> <span class="n">_compute_distance_vector_pbc</span><span class="p">(</span>
            <span class="n">pos_i</span><span class="p">,</span>
            <span class="n">positions</span><span class="p">[</span><span class="n">atom_j</span><span class="p">],</span>
            <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">neighbor_idx</span><span class="p">],</span>
            <span class="n">periodic</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># CN derivative</span>
        <span class="n">f_cn</span><span class="p">,</span> <span class="n">dCN_dr</span> <span class="o">=</span> <span class="n">_cn_counting</span><span class="p">(</span>
            <span class="n">r_inv</span><span class="p">,</span> <span class="n">rcov_i</span><span class="p">,</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]],</span> <span class="n">k1</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># CN-dependent force contribution</span>
        <span class="n">dE_dCN_j</span> <span class="o">=</span> <span class="n">dE_dCN</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">dE_dr_chain</span> <span class="o">=</span> <span class="p">(</span><span class="n">dE_dCN_i</span> <span class="o">+</span> <span class="n">dE_dCN_j</span><span class="p">)</span> <span class="o">*</span> <span class="n">dCN_dr</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">F_chain</span> <span class="o">=</span> <span class="n">dE_dr_chain</span> <span class="o">*</span> <span class="n">r_hat</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>

        <span class="n">F_chain_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">(</span><span class="n">F_chain</span><span class="p">)</span>

        <span class="c1"># Accumulate virial if requested</span>
        <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
            <span class="n">virial_chain_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">(</span><span class="n">wp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">F_chain</span><span class="p">,</span> <span class="n">r_ij</span><span class="p">))</span>

    <span class="c1"># Add accumulated force to existing forces (direct read-modify-write)</span>
    <span class="c1"># Convert from float64 accumulation to float32 output</span>
    <span class="n">forces</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">+</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">(</span><span class="n">F_chain_acc</span><span class="p">)</span>

    <span class="c1"># Add virial contribution with -0.5 scaling for correct sign and double counting</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">atomic_add</span><span class="p">(</span><span class="n">virial</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">(</span><span class="n">virial_chain_acc</span><span class="p">))</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># Neighbor List Kernels</span>
<span class="c1"># ==============================================================================</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_compute_cartesian_shifts_nl</span><span class="p">(</span>
    <span class="n">cell</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">unit_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3i</span><span class="p">),</span>
    <span class="n">neighbor_ptr</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert unit cell shifts to Cartesian coordinates for CSR neighbor lists.</span>

<span class="sd">    For each edge in the CSR neighbor list, this kernel computes the Cartesian</span>
<span class="sd">    shift vector that should be applied to the destination atom&#39;s position.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cell : wp.array(dtype=mat33)</span>
<span class="sd">        Unit cell lattice vectors [num_systems, 3, 3]. Convention: cell[s, i, :]</span>
<span class="sd">        is the i-th lattice vector for system s (row vectors). Units should match</span>
<span class="sd">        position coordinates.</span>
<span class="sd">    unit_shifts : wp.array(dtype=vec3i)</span>
<span class="sd">        Integer unit cell shifts [num_edges] as vec3i</span>
<span class="sd">    neighbor_ptr : wp.array(dtype=int32)</span>
<span class="sd">        CSR row pointers [num_atoms+1]</span>
<span class="sd">    batch_idx : wp.array(dtype=int32)</span>
<span class="sd">        System index [num_atoms] for each atom</span>
<span class="sd">    cartesian_shifts : wp.array(dtype=vec3)</span>
<span class="sd">        Output: Cartesian shift vectors [num_edges] as vec3 in same units as cell vectors</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Launch with dim=num_atoms (one thread per atom). Each thread processes all edges</span>
<span class="sd">    for that atom using the CSR pointers.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`_cn_kernel_nl` : Uses computed Cartesian shifts for PBC</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nl` : Uses computed Cartesian shifts for PBC</span>
<span class="sd">    :func:`_cn_forces_contrib_kernel_nl` : Uses computed Cartesian shifts for PBC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>

    <span class="c1"># Get number of atoms from batch_idx size</span>
    <span class="k">if</span> <span class="n">atom_i</span> <span class="o">&gt;=</span> <span class="n">batch_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>

    <span class="n">system_id</span> <span class="o">=</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">cell_mat</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="n">system_id</span><span class="p">]</span>

    <span class="c1"># Get range of edges for this atom</span>
    <span class="n">j_range_start</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">j_range_end</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Convert all unit shifts for this atom&#39;s neighbors to Cartesian</span>
    <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j_range_start</span><span class="p">,</span> <span class="n">j_range_end</span><span class="p">):</span>
        <span class="n">unit_shift</span> <span class="o">=</span> <span class="n">unit_shifts</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span>
        <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unit_shift_to_cartesian</span><span class="p">(</span><span class="n">unit_shift</span><span class="p">,</span> <span class="n">cell_mat</span><span class="p">)</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_cn_kernel_nl</span><span class="p">(</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">idx_j</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">neighbor_ptr</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">covalent_radii</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">k1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">coord_num</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute coordination numbers using CSR neighbor list format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : wp.array(dtype=vec3)</span>
<span class="sd">        Atomic coordinates [num_atoms]</span>
<span class="sd">    numbers : wp.array(dtype=int32)</span>
<span class="sd">        Atomic numbers [num_atoms]</span>
<span class="sd">    idx_j : wp.array(dtype=int32)</span>
<span class="sd">        Destination atom indices [num_edges] in CSR format</span>
<span class="sd">    neighbor_ptr : wp.array(dtype=int32)</span>
<span class="sd">        CSR row pointers [num_atoms+1]</span>
<span class="sd">    cartesian_shifts : wp.array(dtype=vec3)</span>
<span class="sd">        Cartesian shifts [num_edges] as vec3 for PBC</span>
<span class="sd">    covalent_radii : wp.array(dtype=float32)</span>
<span class="sd">        Covalent radii [max_Z+1] indexed by atomic number</span>
<span class="sd">    k1 : float32</span>
<span class="sd">        Steepness parameter for counting function</span>
<span class="sd">    periodic : bool</span>
<span class="sd">        If True, apply PBC using cartesian_shifts</span>
<span class="sd">    coord_num : wp.array(dtype=float32)</span>
<span class="sd">        Output: coordination numbers [num_atoms]</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Launch with dim=num_atoms (one thread per atom).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">atom_i</span> <span class="o">&gt;=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>

    <span class="c1"># skip padding atoms</span>
    <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">rcov_i</span> <span class="o">=</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]]</span>

    <span class="c1"># Accumulate coordination number in local register</span>
    <span class="n">cn_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Iterate over neighbors using CSR pointers</span>
    <span class="n">j_range_start</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">j_range_end</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j_range_start</span><span class="p">,</span> <span class="n">j_range_end</span><span class="p">):</span>
        <span class="n">atom_j</span> <span class="o">=</span> <span class="n">idx_j</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span>

        <span class="c1"># skip padding atoms</span>
        <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Compute distance with optional PBC shift</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">,</span> <span class="n">r_ij</span> <span class="o">=</span> <span class="n">_compute_distance_vector_pbc</span><span class="p">(</span>
            <span class="n">pos_i</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_j</span><span class="p">],</span> <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">],</span> <span class="n">periodic</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Compute coordination number contribution</span>
        <span class="n">f_cn</span><span class="p">,</span> <span class="n">dCN_dr</span> <span class="o">=</span> <span class="n">_cn_counting</span><span class="p">(</span>
            <span class="n">r_inv</span><span class="p">,</span> <span class="n">rcov_i</span><span class="p">,</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]],</span> <span class="n">k1</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">cn_acc</span> <span class="o">+=</span> <span class="n">f_cn</span>

    <span class="c1"># Write final coordination number once</span>
    <span class="n">coord_num</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cn_acc</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_direct_forces_and_dE_dCN_kernel_nl</span><span class="p">(</span>  <span class="c1"># NOSONAR (S1542) &quot;math formula&quot;</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">idx_j</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">neighbor_ptr</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">coord_num</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">r4r2</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">c6_reference</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">coord_num_ref</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">k3</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">a1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">a2</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s6</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s8</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s5_smoothing_on</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">s5_smoothing_off</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">inv_w</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">compute_virial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">dE_dCN</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">forces</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
    <span class="n">energy</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">virial</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pass 2: Compute direct forces, energy, and accumulate dE/dCN using</span>
<span class="sd">    CSR neighbor list.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Launch with dim=num_atoms (one thread per atom).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">atom_i</span> <span class="o">&gt;=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>

    <span class="c1"># skip padding atoms</span>
    <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">cn_i</span> <span class="o">=</span> <span class="n">coord_num</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">z_i</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">r4r2_i</span> <span class="o">=</span> <span class="n">r4r2</span><span class="p">[</span><span class="n">z_i</span><span class="p">]</span>

    <span class="c1"># Accumulate in local registers (using float64 for better precision)</span>
    <span class="n">F_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">()</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>
    <span class="n">dE_dCN_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>
    <span class="n">energy_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Initialize virial accumulator</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">virial_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">()</span>

    <span class="c1"># Iterate over neighbors using CSR pointers</span>
    <span class="n">j_range_start</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">j_range_end</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j_range_start</span><span class="p">,</span> <span class="n">j_range_end</span><span class="p">):</span>
        <span class="n">atom_j</span> <span class="o">=</span> <span class="n">idx_j</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span>

        <span class="c1"># skip padding atoms</span>
        <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Geometry</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">,</span> <span class="n">r_ij</span> <span class="o">=</span> <span class="n">_compute_distance_vector_pbc</span><span class="p">(</span>
            <span class="n">pos_i</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_j</span><span class="p">],</span> <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">],</span> <span class="n">periodic</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">cn_j</span> <span class="o">=</span> <span class="n">coord_num</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span>
        <span class="n">z_j</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span>

        <span class="c1"># C6 interpolation</span>
        <span class="n">c6ab_mat</span> <span class="o">=</span> <span class="n">c6_reference</span><span class="p">[</span><span class="n">z_i</span><span class="p">,</span> <span class="n">z_j</span><span class="p">]</span>
        <span class="n">cnref_i_mat</span> <span class="o">=</span> <span class="n">coord_num_ref</span><span class="p">[</span><span class="n">z_i</span><span class="p">,</span> <span class="n">z_j</span><span class="p">]</span>
        <span class="n">cnref_j_mat</span> <span class="o">=</span> <span class="n">coord_num_ref</span><span class="p">[</span><span class="n">z_j</span><span class="p">,</span> <span class="n">z_i</span><span class="p">]</span>

        <span class="n">c6_ij</span><span class="p">,</span> <span class="n">dC6_dCNi</span><span class="p">,</span> <span class="n">dC6_dCNj</span> <span class="o">=</span> <span class="n">_c6ab_interpolate</span><span class="p">(</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
            <span class="n">cn_i</span><span class="p">,</span> <span class="n">cn_j</span><span class="p">,</span> <span class="n">c6ab_mat</span><span class="p">,</span> <span class="n">cnref_i_mat</span><span class="p">,</span> <span class="n">cnref_j_mat</span><span class="p">,</span> <span class="n">k3</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">c6_ij</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># BJ damping</span>
        <span class="n">damp_sum</span><span class="p">,</span> <span class="n">r4r2_ij</span><span class="p">,</span> <span class="n">r6</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">den6_inv</span><span class="p">,</span> <span class="n">den8_inv</span> <span class="o">=</span> <span class="n">_bj_damping</span><span class="p">(</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">r4r2_i</span><span class="p">,</span> <span class="n">r4r2</span><span class="p">[</span><span class="n">z_j</span><span class="p">],</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">s6</span><span class="p">,</span> <span class="n">s8</span>
        <span class="p">)</span>

        <span class="c1"># Energy and direct force</span>
        <span class="n">e_ij_sw</span><span class="p">,</span> <span class="n">F_direct</span> <span class="o">=</span> <span class="n">_dispersion_energy_force</span><span class="p">(</span>
            <span class="n">c6_ij</span><span class="p">,</span>
            <span class="n">r</span><span class="p">,</span>
            <span class="n">r_hat</span><span class="p">,</span>
            <span class="n">damp_sum</span><span class="p">,</span>
            <span class="n">r4r2_ij</span><span class="p">,</span>
            <span class="n">r6</span><span class="p">,</span>
            <span class="n">r4</span><span class="p">,</span>
            <span class="n">den6_inv</span><span class="p">,</span>
            <span class="n">den8_inv</span><span class="p">,</span>
            <span class="n">s6</span><span class="p">,</span>
            <span class="n">s8</span><span class="p">,</span>
            <span class="n">s5_smoothing_on</span><span class="p">,</span>
            <span class="n">s5_smoothing_off</span><span class="p">,</span>
            <span class="n">inv_w</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Accumulate in registers</span>
        <span class="n">F_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">(</span><span class="n">F_direct</span><span class="p">)</span>
        <span class="n">energy_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">e_ij_sw</span><span class="p">)</span>
        <span class="n">dE_dCN_acc</span> <span class="o">+=</span> <span class="o">-</span><span class="n">damp_sum</span> <span class="o">*</span> <span class="n">dC6_dCNi</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>

        <span class="c1"># Accumulate virial if requested</span>
        <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
            <span class="n">virial_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">(</span><span class="n">wp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">F_direct</span><span class="p">,</span> <span class="n">r_ij</span><span class="p">))</span>

    <span class="c1"># Write final results once (atomic only for shared batch array)</span>
    <span class="c1"># Convert from float64 accumulation to float32 output</span>
    <span class="n">forces</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">(</span><span class="n">F_acc</span><span class="p">)</span>
    <span class="n">dE_dCN</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">dE_dCN_acc</span><span class="p">)</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">atomic_add</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">energy_acc</span><span class="p">))</span>

    <span class="c1"># Add virial contribution with -0.5 scaling for correct sign and double counting</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">atomic_add</span><span class="p">(</span><span class="n">virial</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">(</span><span class="n">virial_acc</span><span class="p">))</span>


<span class="nd">@wp</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">enable_backward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_cn_forces_contrib_kernel_nl</span><span class="p">(</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">idx_j</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">neighbor_ptr</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">cartesian_shifts</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
    <span class="n">covalent_radii</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">dE_dCN</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">k1</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="n">compute_virial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">forces</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
    <span class="n">virial</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Any</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pass 3: Add CN-dependent force contribution using CSR neighbor list.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Launch with dim=num_atoms (one thread per atom).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_i</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">tid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">atom_i</span> <span class="o">&gt;=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>

    <span class="c1"># skip padding atoms</span>
    <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">dE_dCN_i</span> <span class="o">=</span> <span class="n">dE_dCN</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">rcov_i</span> <span class="o">=</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]]</span>

    <span class="c1"># Accumulate force in local register (using float64 for better precision)</span>
    <span class="n">F_chain_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">()</span>  <span class="c1"># NOSONAR (S117) &quot;math formula&quot;</span>

    <span class="c1"># Initialize virial accumulator</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">virial_chain_acc</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">()</span>

    <span class="c1"># Iterate over neighbors using CSR pointers</span>
    <span class="n">j_range_start</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
    <span class="n">j_range_end</span> <span class="o">=</span> <span class="n">neighbor_ptr</span><span class="p">[</span><span class="n">atom_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j_range_start</span><span class="p">,</span> <span class="n">j_range_end</span><span class="p">):</span>
        <span class="n">atom_j</span> <span class="o">=</span> <span class="n">idx_j</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Distance</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">r_inv</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">,</span> <span class="n">r_ij</span> <span class="o">=</span> <span class="n">_compute_distance_vector_pbc</span><span class="p">(</span>
            <span class="n">pos_i</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="n">atom_j</span><span class="p">],</span> <span class="n">cartesian_shifts</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">],</span> <span class="n">periodic</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># CN derivative</span>
        <span class="n">f_cn</span><span class="p">,</span> <span class="n">dCN_dr</span> <span class="o">=</span> <span class="n">_cn_counting</span><span class="p">(</span>
            <span class="n">r_inv</span><span class="p">,</span> <span class="n">rcov_i</span><span class="p">,</span> <span class="n">covalent_radii</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]],</span> <span class="n">k1</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># CN-dependent force contribution</span>
        <span class="n">dE_dCN_j</span> <span class="o">=</span> <span class="n">dE_dCN</span><span class="p">[</span><span class="n">atom_j</span><span class="p">]</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">dE_dr_chain</span> <span class="o">=</span> <span class="p">(</span><span class="n">dE_dCN_i</span> <span class="o">+</span> <span class="n">dE_dCN_j</span><span class="p">)</span> <span class="o">*</span> <span class="n">dCN_dr</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">F_chain</span> <span class="o">=</span> <span class="n">dE_dr_chain</span> <span class="o">*</span> <span class="n">r_hat</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>

        <span class="n">F_chain_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">(</span><span class="n">F_chain</span><span class="p">)</span>

        <span class="c1"># Accumulate virial if requested</span>
        <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
            <span class="n">virial_chain_acc</span> <span class="o">+=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">(</span><span class="n">wp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">F_chain</span><span class="p">,</span> <span class="n">r_ij</span><span class="p">))</span>

    <span class="c1"># Add accumulated force to existing forces (direct read-modify-write)</span>
    <span class="c1"># Convert from float64 accumulation to float32 output</span>
    <span class="n">forces</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">+</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">(</span><span class="n">F_chain_acc</span><span class="p">)</span>

    <span class="c1"># Add virial contribution with -0.5 scaling for correct sign and double counting</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">atomic_add</span><span class="p">(</span><span class="n">virial</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">[</span><span class="n">atom_i</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">(</span><span class="n">virial_chain_acc</span><span class="p">))</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># Kernel Overload Registration</span>
<span class="c1"># ==============================================================================</span>

<span class="c1"># Type constants for overload generation</span>
<span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
<span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span><span class="p">]</span>
<span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span><span class="p">]</span>

<span class="c1"># Overload dictionaries keyed by scalar type</span>
<span class="n">_compute_cartesian_shifts_overload</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_cn_kernel_nm_overload</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_direct_forces_and_dE_dCN_kernel_nm_overload</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_cn_forces_contrib_kernel_nm_overload</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Neighbor list kernel overload dictionaries (CSR format)</span>
<span class="n">_compute_cartesian_shifts_nl_overload</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_cn_kernel_nl_overload</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_direct_forces_and_dE_dCN_kernel_nl_overload</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_cn_forces_contrib_kernel_nl_overload</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Register overloads for all kernel variants</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="n">_compute_cartesian_shifts_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_compute_cartesian_shifts</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">m</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3i</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_cn_kernel_nm_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_cn_kernel_nm</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_direct_forces_and_dE_dCN_kernel_nm_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_direct_forces_and_dE_dCN_kernel_nm</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_cn_forces_contrib_kernel_nm_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_cn_forces_contrib_kernel_nm</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Neighbor list kernel overloads (CSR format)</span>
    <span class="n">_compute_cartesian_shifts_nl_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_compute_cartesian_shifts_nl</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">m</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3i</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_cn_kernel_nl_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_cn_kernel_nl</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_direct_forces_and_dE_dCN_kernel_nl_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_direct_forces_and_dE_dCN_kernel_nl</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array4d</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_cn_forces_contrib_kernel_nl_overload</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">overload</span><span class="p">(</span>
        <span class="n">_cn_forces_contrib_kernel_nl</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># PyTorch Wrapper</span>
<span class="c1"># ==============================================================================</span>


<span class="nd">@torch</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">custom_op</span><span class="p">(</span>
    <span class="s2">&quot;nvalchemiops::dftd3_nm&quot;</span><span class="p">,</span>
    <span class="n">mutates_args</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;forces&quot;</span><span class="p">,</span> <span class="s2">&quot;coord_num&quot;</span><span class="p">,</span> <span class="s2">&quot;virial&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_dftd3_nm_op</span><span class="p">(</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">neighbor_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">covalent_radii</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">r4r2</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">c6_reference</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">coord_num_ref</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">a1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">a2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">s8</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">energy</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">forces</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">coord_num</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">virial</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">k1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">16.0</span><span class="p">,</span>
    <span class="n">k3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span>
    <span class="n">s6</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">s5_smoothing_on</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span>
    <span class="n">s5_smoothing_off</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cell</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">neighbor_matrix_shifts</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compute_virial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Internal custom op for DFT-D3(BJ) dispersion energy and forces computation.</span>

<span class="sd">    This is a low-level custom operator that performs DFT-D3(BJ) dispersion</span>
<span class="sd">    calculations using Warp kernels. Output tensors must be pre-allocated by</span>
<span class="sd">    the caller and are modified in-place. For most use cases, prefer the</span>
<span class="sd">    higher-level :func:`dftd3` wrapper function instead of calling</span>
<span class="sd">    this method directly.</span>

<span class="sd">    This function is torch.compile compatible.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : torch.Tensor, shape (num_atoms, 3)</span>
<span class="sd">        Atomic coordinates as float32 or float64, in consistent distance units</span>
<span class="sd">        (conventionally Bohr)</span>
<span class="sd">    numbers : torch.Tensor, shape (num_atoms), dtype=int32</span>
<span class="sd">        Atomic numbers</span>
<span class="sd">    neighbor_matrix : torch.Tensor, shape (num_atoms, max_neighbors), dtype=int32</span>
<span class="sd">        Neighbor indices. See module docstring for format details.</span>
<span class="sd">        Padding entries have values &gt;= fill_value.</span>
<span class="sd">    covalent_radii : torch.Tensor, shape (max_Z+1), dtype=float32</span>
<span class="sd">        Covalent radii indexed by atomic number, in same units as positions</span>
<span class="sd">    r4r2 : torch.Tensor, shape (max_Z+1), dtype=float32</span>
<span class="sd">        &lt;r⁴&gt;/&lt;r²&gt; expectation values for C8 computation (dimensionless)</span>
<span class="sd">    c6_reference : torch.Tensor, shape (max_Z+1, max_Z+1, 5, 5), dtype=float32</span>
<span class="sd">        C6 reference values in energy x distance^6 units</span>
<span class="sd">    coord_num_ref : torch.Tensor, shape (max_Z+1, max_Z+1, 5, 5), dtype=float32</span>
<span class="sd">        CN reference grid (dimensionless)</span>
<span class="sd">    a1 : float</span>
<span class="sd">        Becke-Johnson damping parameter 1 (functional-dependent, dimensionless)</span>
<span class="sd">    a2 : float</span>
<span class="sd">        Becke-Johnson damping parameter 2 (functional-dependent), in same units as positions</span>
<span class="sd">    s8 : float</span>
<span class="sd">        C8 term scaling factor (functional-dependent, dimensionless)</span>
<span class="sd">    energy : torch.Tensor, shape (num_systems,), dtype=float32</span>
<span class="sd">        OUTPUT: Total dispersion energy. Must be pre-allocated. Units are energy</span>
<span class="sd">        (Hartree when using standard D3 parameters).</span>
<span class="sd">    forces : torch.Tensor, shape (num_atoms, 3), dtype=float32</span>
<span class="sd">        OUTPUT: Atomic forces. Must be pre-allocated. Units are energy/distance</span>
<span class="sd">        (Hartree/Bohr when using standard D3 parameters).</span>
<span class="sd">    coord_num : torch.Tensor, shape (num_atoms,), dtype=float32</span>
<span class="sd">        OUTPUT: Coordination numbers (dimensionless). Must be pre-allocated.</span>
<span class="sd">    virial : torch.Tensor, shape (num_systems, 3, 3), dtype=float32</span>
<span class="sd">        OUTPUT: Virial tensor. Must be pre-allocated. Units are energy</span>
<span class="sd">        (Hartree when using standard D3 parameters).</span>
<span class="sd">    k1 : float, optional</span>
<span class="sd">        CN counting function steepness parameter, in inverse distance units</span>
<span class="sd">        (typically 16.0 1/Bohr for atomic units)</span>
<span class="sd">    k3 : float, optional</span>
<span class="sd">        CN interpolation Gaussian width parameter (typically -4.0, dimensionless)</span>
<span class="sd">    s6 : float, optional</span>
<span class="sd">        C6 term scaling factor (typically 1.0, dimensionless)</span>
<span class="sd">    s5_smoothing_on : float, optional</span>
<span class="sd">        Distance where S5 switching begins, in same units as positions. Default: 1e10</span>
<span class="sd">    s5_smoothing_off : float, optional</span>
<span class="sd">        Distance where S5 switching completes, in same units as positions. Default: 1e10</span>
<span class="sd">    fill_value : int | None, optional</span>
<span class="sd">        Value indicating padding in neighbor_matrix. If None, defaults to num_atoms.</span>
<span class="sd">    batch_idx : torch.Tensor, shape (num_atoms,), dtype=int32, optional</span>
<span class="sd">        Batch indices. If None, all atoms are in a single system (batch 0).</span>
<span class="sd">    cell : torch.Tensor, shape (num_systems, 3, 3), dtype=float32 or float64, optional</span>
<span class="sd">        Unit cell lattice vectors for PBC, in same dtype and units as positions.</span>
<span class="sd">    neighbor_matrix_shifts : torch.Tensor, shape (num_atoms, max_neighbors, 3), dtype=int32, optional</span>
<span class="sd">        Integer unit cell shifts for PBC.</span>
<span class="sd">    device : str, optional</span>
<span class="sd">        Warp device string (e.g., &#39;cuda:0&#39;, &#39;cpu&#39;). If None, inferred from positions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Modifies input tensors in-place: energy, forces, coord_num, virial (if compute_virial=True)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - All input tensors should use consistent units. Standard D3 parameters use</span>
<span class="sd">      atomic units (Bohr for distances, Hartree for energy).</span>
<span class="sd">    - Float32 or float64 precision for positions and cell; outputs always float32</span>
<span class="sd">    - Padding atoms indicated by numbers[i] == 0</span>
<span class="sd">    - **Two-body only**: Computes pairwise C6 and C8 dispersion terms; three-body</span>
<span class="sd">      Axilrod-Teller-Muto (ATM/C9) terms are not included</span>
<span class="sd">    - Bulk stress tensor can be obtained by dividing virial by system volume.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`dftd3` : Higher-level wrapper that handles allocation</span>
<span class="sd">    :class:`D3Parameters` : Dataclass for organizing DFT-D3 reference parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure all parameters are on correct device/dtype</span>
    <span class="n">covalent_radii</span> <span class="o">=</span> <span class="n">covalent_radii</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">r4r2</span> <span class="o">=</span> <span class="n">r4r2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">c6_reference</span> <span class="o">=</span> <span class="n">c6_reference</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">coord_num_ref</span> <span class="o">=</span> <span class="n">coord_num_ref</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># Get shapes</span>
    <span class="n">num_atoms</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">max_neighbors</span> <span class="o">=</span> <span class="n">neighbor_matrix</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">num_atoms</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Set fill_value if not provided</span>
    <span class="k">if</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fill_value</span> <span class="o">=</span> <span class="n">num_atoms</span>

    <span class="c1"># Handle empty case</span>
    <span class="k">if</span> <span class="n">num_atoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Infer device from positions if not provided</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Zero output tensors</span>
    <span class="n">energy</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    <span class="n">coord_num</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    <span class="n">virial</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

    <span class="c1"># Detect dtype and set appropriate Warp vector types</span>
    <span class="k">if</span> <span class="n">positions</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">vec_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span>
        <span class="n">mat_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span>
        <span class="n">wp_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float64</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vec_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span>
        <span class="n">mat_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span>
        <span class="n">wp_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span>

    <span class="c1"># Create batch indices if not provided (single system)</span>
    <span class="k">if</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Convert PyTorch tensors to Warp arrays (detach positions)</span>
    <span class="n">positions_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vec_dtype</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">numbers_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">neighbor_matrix_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">neighbor_matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">batch_idx_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Convert parameter tensors to Warp arrays (ensure float32)</span>
    <span class="n">covalent_radii_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">covalent_radii</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">r4r2_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">r4r2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">c6_reference_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">c6_reference</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">coord_num_ref_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">coord_num_ref</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Precompute inv_w for S5 switching</span>
    <span class="k">if</span> <span class="n">s5_smoothing_off</span> <span class="o">&gt;</span> <span class="n">s5_smoothing_on</span><span class="p">:</span>
        <span class="n">inv_w</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s5_smoothing_off</span> <span class="o">-</span> <span class="n">s5_smoothing_on</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inv_w</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Pass 0: Handle PBC - determine if periodic and compute cartesian shifts</span>
    <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">neighbor_matrix_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Case 1: Cell and neighbor_matrix_shifts provided - compute cartesian shifts</span>
        <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Detach and convert cell</span>
        <span class="n">cell_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">mat_dtype</span><span class="p">,</span>
            <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert unit shifts to vec3i format</span>
        <span class="n">unit_shifts_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">neighbor_matrix_shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3i</span><span class="p">,</span>
            <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create output array for cartesian shifts [num_atoms, max_neighbors, 3]</span>
        <span class="n">cartesian_shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cartesian_shifts_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">cartesian_shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vec_dtype</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">_compute_cartesian_shifts_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
            <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="p">),</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="n">cell_wp</span><span class="p">,</span>
                <span class="n">unit_shifts_wp</span><span class="p">,</span>
                <span class="n">neighbor_matrix_wp</span><span class="p">,</span>
                <span class="n">batch_idx_wp</span><span class="p">,</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">fill_value</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">cartesian_shifts_wp</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Case 2: No PBC - create zero shifts array (not used but need correct shape for kernel)</span>
        <span class="n">periodic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cartesian_shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cartesian_shifts_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">cartesian_shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vec_dtype</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1"># Convert pre-allocated output arrays to Warp</span>
    <span class="n">coord_num_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">coord_num</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">forces_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">forces</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">energy_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">virial_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">virial</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Allocate dE_dCN array for chain rule computation (internal temporary)</span>
    <span class="n">dE_dCN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span>
    <span class="n">dE_dCN_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">dE_dCN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Pass 1: Compute coordination numbers</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">_cn_kernel_nm_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">num_atoms</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">positions_wp</span><span class="p">,</span>
            <span class="n">numbers_wp</span><span class="p">,</span>
            <span class="n">neighbor_matrix_wp</span><span class="p">,</span>
            <span class="n">cartesian_shifts_wp</span><span class="p">,</span>
            <span class="n">covalent_radii_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">k1</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">fill_value</span><span class="p">),</span>
            <span class="n">periodic</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">coord_num_wp</span><span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Pass 2: Compute direct forces, energy, and accumulate dE/dCN</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">_direct_forces_and_dE_dCN_kernel_nm_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">num_atoms</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">positions_wp</span><span class="p">,</span>
            <span class="n">numbers_wp</span><span class="p">,</span>
            <span class="n">neighbor_matrix_wp</span><span class="p">,</span>
            <span class="n">cartesian_shifts_wp</span><span class="p">,</span>
            <span class="n">coord_num_wp</span><span class="p">,</span>
            <span class="n">r4r2_wp</span><span class="p">,</span>
            <span class="n">c6_reference_wp</span><span class="p">,</span>
            <span class="n">coord_num_ref_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">k3</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">a2</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s6</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s8</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s5_smoothing_on</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s5_smoothing_off</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">inv_w</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">fill_value</span><span class="p">),</span>
            <span class="n">periodic</span><span class="p">,</span>
            <span class="n">batch_idx_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">compute_virial</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">dE_dCN_wp</span><span class="p">,</span> <span class="n">forces_wp</span><span class="p">,</span> <span class="n">energy_wp</span><span class="p">,</span> <span class="n">virial_wp</span><span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Pass 3: Add CN-dependent force contribution</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">_cn_forces_contrib_kernel_nm_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">num_atoms</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">positions_wp</span><span class="p">,</span>
            <span class="n">numbers_wp</span><span class="p">,</span>
            <span class="n">neighbor_matrix_wp</span><span class="p">,</span>
            <span class="n">cartesian_shifts_wp</span><span class="p">,</span>
            <span class="n">covalent_radii_wp</span><span class="p">,</span>
            <span class="n">dE_dCN_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">k1</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">fill_value</span><span class="p">),</span>
            <span class="n">periodic</span><span class="p">,</span>
            <span class="n">batch_idx_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">compute_virial</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">forces_wp</span><span class="p">,</span> <span class="n">virial_wp</span><span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@torch</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">custom_op</span><span class="p">(</span>
    <span class="s2">&quot;nvalchemiops::dftd3_nl&quot;</span><span class="p">,</span>
    <span class="n">mutates_args</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;forces&quot;</span><span class="p">,</span> <span class="s2">&quot;coord_num&quot;</span><span class="p">,</span> <span class="s2">&quot;virial&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_dftd3_nl_op</span><span class="p">(</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">idx_j</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">neighbor_ptr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">covalent_radii</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">r4r2</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">c6_reference</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">coord_num_ref</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">a1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">a2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">s8</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">energy</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">forces</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">coord_num</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">virial</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">k1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">16.0</span><span class="p">,</span>
    <span class="n">k3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span>
    <span class="n">s6</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">s5_smoothing_on</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span>
    <span class="n">s5_smoothing_off</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cell</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unit_shifts</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compute_virial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Internal custom op for DFT-D3(BJ) using CSR neighbor list format.</span>

<span class="sd">    This is a low-level custom operator that performs DFT-D3(BJ) dispersion</span>
<span class="sd">    calculations using CSR (Compressed Sparse Row) neighbor list format with</span>
<span class="sd">    idx_j (destination indices) and neighbor_ptr (row pointers). Output tensors</span>
<span class="sd">    must be pre-allocated by the caller and are modified in-place. For most use</span>
<span class="sd">    cases, prefer the higher-level :func:`dftd3` wrapper</span>
<span class="sd">    function instead of calling this method directly.</span>

<span class="sd">    This function is torch.compile compatible.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : torch.Tensor, shape (num_atoms, 3)</span>
<span class="sd">        Atomic coordinates as float32 or float64</span>
<span class="sd">    numbers : torch.Tensor, shape (num_atoms), dtype=int32</span>
<span class="sd">        Atomic numbers</span>
<span class="sd">    idx_j : torch.Tensor, shape (num_edges,), dtype=int32</span>
<span class="sd">        Destination atom indices (flattened neighbor list in CSR format)</span>
<span class="sd">    neighbor_ptr : torch.Tensor, shape (num_atoms+1,), dtype=int32</span>
<span class="sd">        CSR row pointers where neighbor_ptr[i]:neighbor_ptr[i+1] gives neighbors of atom i</span>
<span class="sd">    covalent_radii : torch.Tensor, shape (max_Z+1), dtype=float32</span>
<span class="sd">        Covalent radii indexed by atomic number</span>
<span class="sd">    r4r2 : torch.Tensor, shape (max_Z+1), dtype=float32</span>
<span class="sd">        &lt;r⁴&gt;/&lt;r²&gt; expectation values</span>
<span class="sd">    c6_reference : torch.Tensor, shape (max_Z+1, max_Z+1, 5, 5), dtype=float32</span>
<span class="sd">        C6 reference values</span>
<span class="sd">    coord_num_ref : torch.Tensor, shape (max_Z+1, max_Z+1, 5, 5), dtype=float32</span>
<span class="sd">        CN reference grid</span>
<span class="sd">    a1 : float</span>
<span class="sd">        Becke-Johnson damping parameter 1</span>
<span class="sd">    a2 : float</span>
<span class="sd">        Becke-Johnson damping parameter 2</span>
<span class="sd">    s8 : float</span>
<span class="sd">        C8 term scaling factor</span>
<span class="sd">    energy : torch.Tensor, shape (num_systems,), dtype=float32</span>
<span class="sd">        OUTPUT: Total dispersion energy</span>
<span class="sd">    forces : torch.Tensor, shape (num_atoms, 3), dtype=float32</span>
<span class="sd">        OUTPUT: Atomic forces</span>
<span class="sd">    coord_num : torch.Tensor, shape (num_atoms,), dtype=float32</span>
<span class="sd">        OUTPUT: Coordination numbers</span>
<span class="sd">    virial : torch.Tensor, shape (num_systems, 3, 3), dtype=float32</span>
<span class="sd">        OUTPUT: Virial tensor. Must be pre-allocated. Units are energy</span>
<span class="sd">        (Hartree when using standard D3 parameters).</span>
<span class="sd">    k1 : float, optional</span>
<span class="sd">        CN counting function steepness parameter</span>
<span class="sd">    k3 : float, optional</span>
<span class="sd">        CN interpolation Gaussian width parameter</span>
<span class="sd">    s6 : float, optional</span>
<span class="sd">        C6 term scaling factor</span>
<span class="sd">    s5_smoothing_on : float, optional</span>
<span class="sd">        Distance where S5 switching begins</span>
<span class="sd">    s5_smoothing_off : float, optional</span>
<span class="sd">        Distance where S5 switching completes</span>
<span class="sd">    batch_idx : torch.Tensor, shape (num_atoms,), dtype=int32, optional</span>
<span class="sd">        Batch indices</span>
<span class="sd">    cell : torch.Tensor, shape (num_systems, 3, 3), dtype=float32 or float64, optional</span>
<span class="sd">        Unit cell lattice vectors for PBC, in same dtype and units as positions.</span>
<span class="sd">    unit_shifts : torch.Tensor, shape (num_edges, 3), dtype=int32, optional</span>
<span class="sd">        Integer unit cell shifts for PBC</span>
<span class="sd">    device : str, optional</span>
<span class="sd">        Warp device string</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Modifies input tensors in-place: energy, forces, coord_num, virial (if compute_virial=True)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - All input tensors should use consistent units. Standard D3 parameters use</span>
<span class="sd">      atomic units (Bohr for distances, Hartree for energy).</span>
<span class="sd">    - Float32 or float64 precision for positions and cell; outputs always float32</span>
<span class="sd">    - Padding atoms indicated by numbers[i] == 0</span>
<span class="sd">    - **Two-body only**: Computes pairwise C6 and C8 dispersion terms; three-body</span>
<span class="sd">      Axilrod-Teller-Muto (ATM/C9) terms are not included</span>
<span class="sd">    - Bulk stress tensor can be obtained by dividing virial by system volume.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`dftd3` : Higher-level wrapper that handles allocation</span>
<span class="sd">    :class:`D3Parameters` : Dataclass for organizing DFT-D3 reference parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure all parameters are on correct device/dtype</span>
    <span class="n">covalent_radii</span> <span class="o">=</span> <span class="n">covalent_radii</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">r4r2</span> <span class="o">=</span> <span class="n">r4r2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">c6_reference</span> <span class="o">=</span> <span class="n">c6_reference</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">coord_num_ref</span> <span class="o">=</span> <span class="n">coord_num_ref</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Get shapes</span>
    <span class="n">num_atoms</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">num_edges</span> <span class="o">=</span> <span class="n">idx_j</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Handle empty case</span>
    <span class="k">if</span> <span class="n">num_atoms</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num_edges</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Infer device from positions if not provided</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Zero output tensors</span>
    <span class="n">energy</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    <span class="n">coord_num</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    <span class="n">virial</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

    <span class="c1"># Detect dtype and set appropriate Warp vector types</span>
    <span class="k">if</span> <span class="n">positions</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">vec_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3d</span>
        <span class="n">wp_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float64</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vec_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span>
        <span class="n">wp_dtype</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">float32</span>

    <span class="c1"># Create batch indices if not provided (single system)</span>
    <span class="k">if</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Convert PyTorch tensors to Warp arrays</span>
    <span class="n">positions_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vec_dtype</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">numbers_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">idx_j_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">idx_j</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">neighbor_ptr_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">neighbor_ptr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">batch_idx_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Convert parameter tensors to Warp arrays</span>
    <span class="n">covalent_radii_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">covalent_radii</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">r4r2_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">r4r2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">c6_reference_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">c6_reference</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">coord_num_ref_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">coord_num_ref</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Precompute inv_w for S5 switching</span>
    <span class="k">if</span> <span class="n">s5_smoothing_off</span> <span class="o">&gt;</span> <span class="n">s5_smoothing_on</span><span class="p">:</span>
        <span class="n">inv_w</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s5_smoothing_off</span> <span class="o">-</span> <span class="n">s5_smoothing_on</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inv_w</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Pass 0: Handle PBC - compute cartesian shifts if needed</span>
    <span class="k">if</span> <span class="n">unit_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># PBC case - convert unit shifts to Cartesian using Warp kernel</span>
        <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Convert cell to Warp</span>
        <span class="n">cell_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33d</span> <span class="k">if</span> <span class="n">positions</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span> <span class="k">else</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">,</span>
            <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert unit shifts to vec3i format</span>
        <span class="n">unit_shifts_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">unit_shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3i</span><span class="p">,</span>
            <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert neighbor_ptr to Warp</span>
        <span class="n">neighbor_ptr_wp_shifts</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">neighbor_ptr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Create batch_idx if not provided (single system)</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_idx_shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_idx_shifts</span> <span class="o">=</span> <span class="n">batch_idx</span>
        <span class="n">batch_idx_shifts_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">batch_idx_shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Allocate output for Cartesian shifts</span>
        <span class="n">cartesian_shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num_edges</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cartesian_shifts_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
            <span class="n">cartesian_shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vec_dtype</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Launch kernel to compute Cartesian shifts</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">_compute_cartesian_shifts_nl_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
            <span class="n">dim</span><span class="o">=</span><span class="n">num_atoms</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="n">cell_wp</span><span class="p">,</span>
                <span class="n">unit_shifts_wp</span><span class="p">,</span>
                <span class="n">neighbor_ptr_wp_shifts</span><span class="p">,</span>
                <span class="n">batch_idx_shifts_wp</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">cartesian_shifts_wp</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Non-periodic case - create zero shifts</span>
        <span class="n">periodic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cartesian_shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num_edges</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Convert cartesian shifts to Warp</span>
    <span class="n">cartesian_shifts_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>
        <span class="n">cartesian_shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vec_dtype</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Convert pre-allocated output arrays to Warp</span>
    <span class="n">coord_num_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">coord_num</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">forces_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">forces</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3f</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">energy_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">virial_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span><span class="n">virial</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33f</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Allocate dE_dCN array for chain rule computation</span>
    <span class="n">dE_dCN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span>
    <span class="n">dE_dCN_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">from_torch</span><span class="p">(</span>  <span class="c1"># NOSONAR (S125) &quot;math formula&quot;</span>
        <span class="n">dE_dCN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">return_ctype</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Pass 1: Compute coordination numbers</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">_cn_kernel_nl_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">num_atoms</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">positions_wp</span><span class="p">,</span>
            <span class="n">numbers_wp</span><span class="p">,</span>
            <span class="n">idx_j_wp</span><span class="p">,</span>
            <span class="n">neighbor_ptr_wp</span><span class="p">,</span>
            <span class="n">cartesian_shifts_wp</span><span class="p">,</span>
            <span class="n">covalent_radii_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">k1</span><span class="p">),</span>
            <span class="n">periodic</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">coord_num_wp</span><span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Pass 2: Compute direct forces, energy, and accumulate dE/dCN</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">_direct_forces_and_dE_dCN_kernel_nl_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">num_atoms</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">positions_wp</span><span class="p">,</span>
            <span class="n">numbers_wp</span><span class="p">,</span>
            <span class="n">idx_j_wp</span><span class="p">,</span>
            <span class="n">neighbor_ptr_wp</span><span class="p">,</span>
            <span class="n">cartesian_shifts_wp</span><span class="p">,</span>
            <span class="n">coord_num_wp</span><span class="p">,</span>
            <span class="n">r4r2_wp</span><span class="p">,</span>
            <span class="n">c6_reference_wp</span><span class="p">,</span>
            <span class="n">coord_num_ref_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">k3</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">a2</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s6</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s8</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s5_smoothing_on</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">s5_smoothing_off</span><span class="p">),</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">inv_w</span><span class="p">),</span>
            <span class="n">periodic</span><span class="p">,</span>
            <span class="n">batch_idx_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">compute_virial</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">dE_dCN_wp</span><span class="p">,</span> <span class="n">forces_wp</span><span class="p">,</span> <span class="n">energy_wp</span><span class="p">,</span> <span class="n">virial_wp</span><span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Pass 3: Add CN-dependent force contribution</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">_cn_forces_contrib_kernel_nl_overload</span><span class="p">[</span><span class="n">wp_dtype</span><span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">num_atoms</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">positions_wp</span><span class="p">,</span>
            <span class="n">numbers_wp</span><span class="p">,</span>
            <span class="n">idx_j_wp</span><span class="p">,</span>
            <span class="n">neighbor_ptr_wp</span><span class="p">,</span>
            <span class="n">cartesian_shifts_wp</span><span class="p">,</span>
            <span class="n">covalent_radii_wp</span><span class="p">,</span>
            <span class="n">dE_dCN_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">k1</span><span class="p">),</span>
            <span class="n">periodic</span><span class="p">,</span>
            <span class="n">batch_idx_wp</span><span class="p">,</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">compute_virial</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">forces_wp</span><span class="p">,</span> <span class="n">virial_wp</span><span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>


<div class="viewcode-block" id="dftd3">
<a class="viewcode-back" href="../../../../modules/dispersion.html#nvalchemiops.interactions.dispersion.dftd3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dftd3</span><span class="p">(</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">a1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">a2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">s8</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">k1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">16.0</span><span class="p">,</span>
    <span class="n">k3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span>
    <span class="n">s6</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">s5_smoothing_on</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span>
    <span class="n">s5_smoothing_off</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">d3_params</span><span class="p">:</span> <span class="n">D3Parameters</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">covalent_radii</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">r4r2</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">c6_reference</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">coord_num_ref</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cell</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">neighbor_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">neighbor_matrix_shifts</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">neighbor_list</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">neighbor_ptr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unit_shifts</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compute_virial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">num_systems</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
    <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute DFT-D3(BJ) dispersion energy and forces using Warp</span>
<span class="sd">    with optional periodic boundary condition support and smoothing function.</span>

<span class="sd">    **DFT-D3 parameters must be explicitly provided** using one of three methods:</span>

<span class="sd">    1. **D3Parameters dataclass**: Supply a :class:`D3Parameters` instance (recommended).</span>
<span class="sd">       Individual parameters can override dataclass values if both are provided.</span>

<span class="sd">    2. **Explicit parameters**: Supply all four parameters individually:</span>
<span class="sd">       ``covalent_radii``, ``r4r2``, ``c6_reference``, and ``coord_num_ref``.</span>

<span class="sd">    3. **Dictionary**: Provide a ``d3_params`` dictionary with keys:</span>
<span class="sd">       ``&quot;rcov&quot;``, ``&quot;r4r2&quot;``, ``&quot;c6ab&quot;``, and ``&quot;cn_ref&quot;``.</span>
<span class="sd">       Individual parameters can override dictionary values if both are provided.</span>

<span class="sd">    See ``examples/interactions/utils.py`` for parameter generation utilities.</span>

<span class="sd">    This wrapper can be launched by either supplying a neighbor matrix or a</span>
<span class="sd">    neighbor list, both of which can be generated by the :func:`nvalchemiops.neighborlist.neighbor_list` function where the latter can be returned by setting the `return_neighbor_list` parameter to True.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : torch.Tensor</span>
<span class="sd">        Atomic coordinates [num_atoms, 3] as float32 or float64, in consistent distance</span>
<span class="sd">        units (conventionally Bohr when using standard D3 parameters)</span>
<span class="sd">    numbers : torch.Tensor</span>
<span class="sd">        Atomic numbers [num_atoms] as int32</span>
<span class="sd">    a1 : float</span>
<span class="sd">        Becke-Johnson damping parameter 1 (functional-dependent, dimensionless)</span>
<span class="sd">    a2 : float</span>
<span class="sd">        Becke-Johnson damping parameter 2 (functional-dependent), in same units as positions</span>
<span class="sd">    s8 : float</span>
<span class="sd">        C8 term scaling factor (functional-dependent, dimensionless)</span>
<span class="sd">    k1 : float, optional</span>
<span class="sd">        CN counting function steepness parameter, in inverse distance units</span>
<span class="sd">        (typically 16.0 1/Bohr for atomic units)</span>
<span class="sd">    k3 : float, optional</span>
<span class="sd">        CN interpolation Gaussian width parameter (typically -4.0, dimensionless)</span>
<span class="sd">    s6 : float, optional</span>
<span class="sd">        C6 term scaling factor (typically 1.0, dimensionless)</span>
<span class="sd">    s5_smoothing_on : float, optional</span>
<span class="sd">        Distance where S5 switching begins, in same units as positions. Set greater or</span>
<span class="sd">        equal to s5_smoothing_off to disable smoothing. Default: 1e10</span>
<span class="sd">    s5_smoothing_off : float, optional</span>
<span class="sd">        Distance where S5 switching completes, in same units as positions.</span>
<span class="sd">        Default: 1e10 (effectively no cutoff)</span>
<span class="sd">    fill_value : int | None, optional</span>
<span class="sd">        Value indicating padding in neighbor_matrix. If None, defaults to num_atoms.</span>
<span class="sd">        Entries with neighbor_matrix[i, k] &gt;= fill_value are treated as padding. Default: None</span>
<span class="sd">    d3_params : D3Parameters | dict[str, torch.Tensor] | None, optional</span>
<span class="sd">        DFT-D3 parameters provided as either:</span>
<span class="sd">        - :class:`D3Parameters` dataclass instance (recommended)</span>
<span class="sd">        - Dictionary with keys: &quot;rcov&quot;, &quot;r4r2&quot;, &quot;c6ab&quot;, &quot;cn_ref&quot;</span>
<span class="sd">        Individual parameters below can override values from d3_params.</span>
<span class="sd">    covalent_radii : torch.Tensor | None, optional</span>
<span class="sd">        Covalent radii [max_Z+1] as float32, indexed by atomic number, in same units</span>
<span class="sd">        as positions. If provided, overrides the value in d3_params.</span>
<span class="sd">    r4r2 : torch.Tensor | None, optional</span>
<span class="sd">        &lt;r4&gt;/&lt;r2&gt; expectation values [max_Z+1] as float32 for C8 computation (dimensionless).</span>
<span class="sd">        If provided, overrides the value in d3_params.</span>
<span class="sd">    c6_reference : torch.Tensor | None, optional</span>
<span class="sd">        C6 reference values [max_Z+1, max_Z+1, 5, 5] as float32 in energy × distance^6 units.</span>
<span class="sd">        If provided, overrides the value in d3_params.</span>
<span class="sd">    coord_num_ref : torch.Tensor | None, optional</span>
<span class="sd">        CN reference grid [max_Z+1, max_Z+1, 5, 5] as float32 (dimensionless).</span>
<span class="sd">        If provided, overrides the value in d3_params.</span>
<span class="sd">    batch_idx : torch.Tensor or None, optional</span>
<span class="sd">        Batch indices [num_atoms] as int32. If None, all atoms are assumed</span>
<span class="sd">        to be in a single system (batch 0). For batched calculations, atoms with</span>
<span class="sd">        the same batch index belong to the same system. Default: None</span>
<span class="sd">    cell : torch.Tensor or None, optional, as float32 or float64</span>
<span class="sd">        Unit cell lattice vectors [num_systems, 3, 3] for PBC, in same dtype and units as positions.</span>
<span class="sd">        Convention: cell[s, i, :] is i-th lattice vector for system s.</span>
<span class="sd">        If None, non-periodic calculation. Default: None</span>
<span class="sd">    neighbor_matrix : torch.Tensor | None, optional</span>
<span class="sd">        Neighbor indices [num_atoms, max_neighbors] as int32. See module docstring for</span>
<span class="sd">        details on the format. Padding entries have values &gt;= fill_value.</span>
<span class="sd">        Mutually exclusive with neighbor_list. Default: None</span>
<span class="sd">    neighbor_matrix_shifts : torch.Tensor or None, optional</span>
<span class="sd">        Integer unit cell shifts [num_atoms, max_neighbors, 3] as int32 for PBC with</span>
<span class="sd">        neighbor_matrix format. If None, non-periodic calculation. If provided along</span>
<span class="sd">        with cell, Cartesian shifts are computed. Mutually exclusive with unit_shifts.</span>
<span class="sd">        Default: None</span>
<span class="sd">    neighbor_list : torch.Tensor or None, optional</span>
<span class="sd">        Neighbor pairs [2, num_pairs] as int32 in COO format, where row 0 contains</span>
<span class="sd">        source atom indices and row 1 contains target atom indices. Alternative to</span>
<span class="sd">        neighbor_matrix for sparse neighbor representations. Mutually exclusive with</span>
<span class="sd">        neighbor_matrix. Must be used together with `neighbor_ptr` (both are returned</span>
<span class="sd">        by the neighbor list API when `return_neighbor_list=True`).</span>
<span class="sd">        Default: None</span>
<span class="sd">    neighbor_ptr : torch.Tensor or None, optional</span>
<span class="sd">        CSR row pointers [num_atoms+1] as int32. Required when using `neighbor_list`.</span>
<span class="sd">        Indicates that `neighbor_list[1, :]` contains destination atoms in CSR</span>
<span class="sd">        format where</span>
<span class="sd">        `neighbor_ptr[i]:neighbor_ptr[i+1]` gives the range of neighbors for atom i.</span>
<span class="sd">        Returned by the neighbor list API when `return_neighbor_list=True`.</span>
<span class="sd">        Default: None</span>
<span class="sd">    unit_shifts : torch.Tensor or None, optional</span>
<span class="sd">        Integer unit cell shifts [num_pairs, 3] as int32 for PBC with neighbor_list</span>
<span class="sd">        format. If None, non-periodic calculation. If provided along with cell,</span>
<span class="sd">        Cartesian shifts are computed. Mutually exclusive with neighbor_matrix_shifts.</span>
<span class="sd">        Default: None</span>
<span class="sd">    compute_virial : bool, optional</span>
<span class="sd">        If True, allocate and compute virial tensor. Ignored if virial</span>
<span class="sd">        parameter is provided. Default: False</span>
<span class="sd">    num_systems : int, optional</span>
<span class="sd">        Number of systems in batch. In none provided, inferred from cell</span>
<span class="sd">        or from batch_idx (introcudes CUDA synchronization overhead). Default: None</span>
<span class="sd">    device : str or None, optional</span>
<span class="sd">        Warp device string (e.g., &#39;cuda:0&#39;, &#39;cpu&#39;). If None, inferred from</span>
<span class="sd">        positions tensor. Default: None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    energy : torch.Tensor</span>
<span class="sd">        Total dispersion energy [num_systems] as float32. Units are energy</span>
<span class="sd">        (Hartree when using standard D3 parameters).</span>
<span class="sd">    forces : torch.Tensor</span>
<span class="sd">        Atomic forces [num_atoms, 3] as float32. Units are energy/distance</span>
<span class="sd">        (Hartree/Bohr when using standard D3 parameters).</span>
<span class="sd">    coord_num : torch.Tensor</span>
<span class="sd">        Coordination numbers [num_atoms] as float32 (dimensionless)</span>
<span class="sd">    virial : torch.Tensor, optional</span>
<span class="sd">        Virial tensor [num_systems, 3, 3] as float32.</span>
<span class="sd">        Units are energy (Hartree when using standard D3 parameters). Only returned</span>
<span class="sd">        if compute_virial=True.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - **Unit consistency**: All inputs must use consistent units. Standard D3 parameters</span>
<span class="sd">      from the Grimme group use atomic units (Bohr for distances, Hartree for energy),</span>
<span class="sd">      so using atomic units throughout is recommended and conventional.</span>
<span class="sd">    - Float32 or float64 precision for positions and cell; outputs always float32</span>
<span class="sd">    - **Neighbor formats**: Supports both neighbor_matrix (dense) and neighbor_list (sparse COO)</span>
<span class="sd">      formats. Choose neighbor_list for sparse systems or when memory efficiency is important.</span>
<span class="sd">    - Padding atoms indicated by numbers[i] == 0</span>
<span class="sd">    - Requires symmetric neighbor representation (each pair appears twice)</span>
<span class="sd">    - **Two-body only**: Computes pairwise C6 and C8 dispersion terms; three-body</span>
<span class="sd">      Axilrod-Teller-Muto (ATM/C9) terms are not included</span>
<span class="sd">    - Virial computation requires periodic boundary conditions.</span>
<span class="sd">    - Bulk stress tensor can be obtained by dividing virial by system volume.</span>

<span class="sd">    **Neighbor Format Selection**:</span>

<span class="sd">    - Use neighbor_matrix for dense systems or when max_neighbors is small</span>
<span class="sd">    - Use neighbor_list for sparse systems, large cutoffs, or memory-constrained scenarios</span>
<span class="sd">    - Both formats produce identical results and support PBC</span>

<span class="sd">    **PBC Handling**:</span>

<span class="sd">    - Matrix format: Provide cell and neighbor_matrix_shifts</span>
<span class="sd">    - List format: Provide cell and unit_shifts</span>
<span class="sd">    - Non-periodic: Omit both cell and shift parameters</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :class:`D3Parameters` : Dataclass for organizing DFT-D3 reference parameters</span>
<span class="sd">    :func:`_dftd3_nm_op` : Internal custom operator for neighbor matrix format</span>
<span class="sd">    :func:`_dftd3_nl_op` : Internal custom operator for neighbor list format</span>
<span class="sd">    :func:`_compute_cartesian_shifts` : Pass 0 - Converts unit cell shifts to Cartesian</span>
<span class="sd">    :func:`_cn_kernel_nm` : Pass 1 - Computes coordination numbers (neighbor matrix)</span>
<span class="sd">    :func:`_cn_kernel_nl` : Pass 1 - Computes coordination numbers (neighbor list)</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nm` : Pass 2 - neighbor matrix format</span>
<span class="sd">    :func:`_direct_forces_and_dE_dCN_kernel_nl` : Pass 2 - neighbor list format</span>
<span class="sd">    :func:`_cn_forces_contrib_kernel_nm` : Pass 3 - neighbor matrix format</span>
<span class="sd">    :func:`_cn_forces_contrib_kernel_nl` : Pass 3 - neighbor list format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate neighbor format inputs</span>
    <span class="n">matrix_provided</span> <span class="o">=</span> <span class="n">neighbor_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">list_provided</span> <span class="o">=</span> <span class="n">neighbor_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">matrix_provided</span> <span class="ow">and</span> <span class="n">list_provided</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot provide both neighbor_matrix and neighbor_list. &quot;</span>
            <span class="s2">&quot;Please provide only one neighbor representation format.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matrix_provided</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">list_provided</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either neighbor_matrix or neighbor_list.&quot;</span><span class="p">)</span>

    <span class="c1"># Validate PBC shift inputs match neighbor format</span>
    <span class="k">if</span> <span class="n">matrix_provided</span> <span class="ow">and</span> <span class="n">unit_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;unit_shifts is for neighbor_list format. &quot;</span>
            <span class="s2">&quot;Use neighbor_matrix_shifts for neighbor_matrix format.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">list_provided</span> <span class="ow">and</span> <span class="n">neighbor_matrix_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;neighbor_matrix_shifts is for neighbor_matrix format. &quot;</span>
            <span class="s2">&quot;Use unit_shifts for neighbor_list format.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate neighbor_ptr is provided when using neighbor_list format</span>
    <span class="k">if</span> <span class="n">list_provided</span> <span class="ow">and</span> <span class="n">neighbor_ptr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;neighbor_ptr must be provided when using neighbor_list format. &quot;</span>
            <span class="s2">&quot;Obtain it from the neighbor list API by setting return_neighbor_list=True.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate functional parameters</span>
    <span class="k">if</span> <span class="n">a1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">a2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s8</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Functional parameters a1, a2, and s8 must be provided. &quot;</span>
            <span class="s2">&quot;These are functional-dependent parameters required for DFT-D3(BJ) calculations.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate virial computation requires PBC</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Virial computation requires periodic boundary conditions. &quot;</span>
                <span class="s2">&quot;Please provide unit cell parameters (cell) and shifts &quot;</span>
                <span class="s2">&quot;(neighbor_matrix_shifts or unit_shifts) when compute_virial=True &quot;</span>
                <span class="s2">&quot;or when passing a virial tensor.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">matrix_provided</span> <span class="ow">and</span> <span class="n">neighbor_matrix_shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Virial computation requires periodic boundary conditions. &quot;</span>
                <span class="s2">&quot;Please provide neighbor_matrix_shifts along with cell when using &quot;</span>
                <span class="s2">&quot;neighbor_matrix format and compute_virial=True or passing a virial tensor.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">list_provided</span> <span class="ow">and</span> <span class="n">unit_shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Virial computation requires periodic boundary conditions. &quot;</span>
                <span class="s2">&quot;Please provide unit_shifts along with cell when using &quot;</span>
                <span class="s2">&quot;neighbor_list format and compute_virial=True or passing a virial tensor.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Determine how parameters are being supplied</span>
    <span class="c1"># Case 1: All individual parameters provided explicitly</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">covalent_radii</span><span class="p">,</span> <span class="n">r4r2</span><span class="p">,</span> <span class="n">c6_reference</span><span class="p">,</span> <span class="n">coord_num_ref</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="c1"># Use explicit parameters directly (already assigned)</span>
        <span class="k">pass</span>
    <span class="c1"># Case 2: d3_params provided (D3Parameters or dictionary, with optional overrides)</span>
    <span class="k">elif</span> <span class="n">d3_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Convert D3Parameters to dictionary for consistent access</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d3_params</span><span class="p">,</span> <span class="n">D3Parameters</span><span class="p">):</span>
            <span class="n">d3_params</span> <span class="o">=</span> <span class="n">d3_params</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="c1"># these are written to throw KeyError if the keys are not present</span>
        <span class="k">if</span> <span class="n">covalent_radii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">covalent_radii</span> <span class="o">=</span> <span class="n">d3_params</span><span class="p">[</span><span class="s2">&quot;rcov&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">r4r2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r4r2</span> <span class="o">=</span> <span class="n">d3_params</span><span class="p">[</span><span class="s2">&quot;r4r2&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c6_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c6_reference</span> <span class="o">=</span> <span class="n">d3_params</span><span class="p">[</span><span class="s2">&quot;c6ab&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coord_num_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coord_num_ref</span> <span class="o">=</span> <span class="n">d3_params</span><span class="p">[</span><span class="s2">&quot;cn_ref&quot;</span><span class="p">]</span>
    <span class="c1"># Case 3: No parameters provided - raise error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;DFT-D3 parameters must be explicitly provided. &quot;</span>
            <span class="s2">&quot;Either supply all individual parameters (covalent_radii, r4r2, &quot;</span>
            <span class="s2">&quot;c6_reference, coord_num_ref), provide a D3Parameters instance, &quot;</span>
            <span class="s2">&quot;or provide a d3_params dictionary. See the function docstring for details.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get shapes</span>
    <span class="n">num_atoms</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Handle empty case</span>
    <span class="k">if</span> <span class="n">num_atoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">batch_idx</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">num_systems</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_systems</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_idx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">empty_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">num_systems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="n">empty_forces</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">empty_cn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Handle virial for empty case if compute_virial is True</span>
        <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
            <span class="n">empty_virial</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">empty_energy</span><span class="p">,</span> <span class="n">empty_forces</span><span class="p">,</span> <span class="n">empty_cn</span><span class="p">,</span> <span class="n">empty_virial</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">empty_energy</span><span class="p">,</span> <span class="n">empty_forces</span><span class="p">,</span> <span class="n">empty_cn</span>

    <span class="c1"># Determine number of systems for energy allocation</span>
    <span class="k">if</span> <span class="n">num_systems</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_systems</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_systems</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_systems</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_idx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Allocate output tensors</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_systems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">forces</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">coord_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="n">virial</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num_systems</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">virial</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">positions</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Dispatch to appropriate implementation based on neighbor format</span>
    <span class="k">if</span> <span class="n">neighbor_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Matrix format - call custom op</span>
        <span class="n">_dftd3_nm_op</span><span class="p">(</span>
            <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
            <span class="n">numbers</span><span class="o">=</span><span class="n">numbers</span><span class="p">,</span>
            <span class="n">neighbor_matrix</span><span class="o">=</span><span class="n">neighbor_matrix</span><span class="p">,</span>
            <span class="n">covalent_radii</span><span class="o">=</span><span class="n">covalent_radii</span><span class="p">,</span>
            <span class="n">r4r2</span><span class="o">=</span><span class="n">r4r2</span><span class="p">,</span>
            <span class="n">c6_reference</span><span class="o">=</span><span class="n">c6_reference</span><span class="p">,</span>
            <span class="n">coord_num_ref</span><span class="o">=</span><span class="n">coord_num_ref</span><span class="p">,</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="p">,</span>
            <span class="n">s8</span><span class="o">=</span><span class="n">s8</span><span class="p">,</span>
            <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
            <span class="n">forces</span><span class="o">=</span><span class="n">forces</span><span class="p">,</span>
            <span class="n">coord_num</span><span class="o">=</span><span class="n">coord_num</span><span class="p">,</span>
            <span class="n">k1</span><span class="o">=</span><span class="n">k1</span><span class="p">,</span>
            <span class="n">k3</span><span class="o">=</span><span class="n">k3</span><span class="p">,</span>
            <span class="n">s6</span><span class="o">=</span><span class="n">s6</span><span class="p">,</span>
            <span class="n">s5_smoothing_on</span><span class="o">=</span><span class="n">s5_smoothing_on</span><span class="p">,</span>
            <span class="n">s5_smoothing_off</span><span class="o">=</span><span class="n">s5_smoothing_off</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
            <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
            <span class="n">neighbor_matrix_shifts</span><span class="o">=</span><span class="n">neighbor_matrix_shifts</span><span class="p">,</span>
            <span class="n">virial</span><span class="o">=</span><span class="n">virial</span><span class="p">,</span>
            <span class="n">compute_virial</span><span class="o">=</span><span class="n">compute_virial</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># List format - use CSR format from neighbor list API</span>
        <span class="c1"># neighbor_list: [2, num_pairs] in COO format where row 1 is idx_j (destination atoms)</span>
        <span class="c1"># neighbor_ptr: [num_atoms+1] CSR row pointers (required, from neighbor list API)</span>

        <span class="c1"># Extract idx_j from neighbor_list (row 1 contains destination atoms)</span>
        <span class="n">idx_j_csr</span> <span class="o">=</span> <span class="n">neighbor_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">_dftd3_nl_op</span><span class="p">(</span>
            <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
            <span class="n">numbers</span><span class="o">=</span><span class="n">numbers</span><span class="p">,</span>
            <span class="n">idx_j</span><span class="o">=</span><span class="n">idx_j_csr</span><span class="p">,</span>
            <span class="n">neighbor_ptr</span><span class="o">=</span><span class="n">neighbor_ptr</span><span class="p">,</span>
            <span class="n">covalent_radii</span><span class="o">=</span><span class="n">covalent_radii</span><span class="p">,</span>
            <span class="n">r4r2</span><span class="o">=</span><span class="n">r4r2</span><span class="p">,</span>
            <span class="n">c6_reference</span><span class="o">=</span><span class="n">c6_reference</span><span class="p">,</span>
            <span class="n">coord_num_ref</span><span class="o">=</span><span class="n">coord_num_ref</span><span class="p">,</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="p">,</span>
            <span class="n">s8</span><span class="o">=</span><span class="n">s8</span><span class="p">,</span>
            <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
            <span class="n">forces</span><span class="o">=</span><span class="n">forces</span><span class="p">,</span>
            <span class="n">coord_num</span><span class="o">=</span><span class="n">coord_num</span><span class="p">,</span>
            <span class="n">k1</span><span class="o">=</span><span class="n">k1</span><span class="p">,</span>
            <span class="n">k3</span><span class="o">=</span><span class="n">k3</span><span class="p">,</span>
            <span class="n">s6</span><span class="o">=</span><span class="n">s6</span><span class="p">,</span>
            <span class="n">s5_smoothing_on</span><span class="o">=</span><span class="n">s5_smoothing_on</span><span class="p">,</span>
            <span class="n">s5_smoothing_off</span><span class="o">=</span><span class="n">s5_smoothing_off</span><span class="p">,</span>
            <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
            <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
            <span class="n">unit_shifts</span><span class="o">=</span><span class="n">unit_shifts</span><span class="p">,</span>
            <span class="n">virial</span><span class="o">=</span><span class="n">virial</span><span class="p">,</span>
            <span class="n">compute_virial</span><span class="o">=</span><span class="n">compute_virial</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">compute_virial</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">forces</span><span class="p">,</span> <span class="n">coord_num</span><span class="p">,</span> <span class="n">virial</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">forces</span><span class="p">,</span> <span class="n">coord_num</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, NVIDIA.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>